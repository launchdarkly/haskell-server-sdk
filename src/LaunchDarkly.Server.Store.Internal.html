<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">LaunchDarkly.Server.Store.Internal</span><span>
</span><span id="line-4"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#isInitialized"><span class="hs-identifier">isInitialized</span></a></span><span>
</span><span id="line-5"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getAllFlags"><span class="hs-identifier">getAllFlags</span></a></span><span>
</span><span id="line-6"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getFlag"><span class="hs-identifier">getFlag</span></a></span><span>
</span><span id="line-7"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getSegment"><span class="hs-identifier">getSegment</span></a></span><span>
</span><span id="line-8"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#upsertFlag"><span class="hs-identifier">upsertFlag</span></a></span><span>
</span><span id="line-9"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#upsertSegment"><span class="hs-identifier">upsertSegment</span></a></span><span>
</span><span id="line-10"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#initialize"><span class="hs-identifier">initialize</span></a></span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier">StoreResult</span></a></span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier">StoreResultM</span></a></span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#PersistentDataStore"><span class="hs-identifier">PersistentDataStore</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreHandle"><span class="hs-identifier">StoreHandle</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreRead"><span class="hs-identifier">LaunchDarklyStoreRead</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreWrite"><span class="hs-identifier">LaunchDarklyStoreWrite</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#makeStoreIO"><span class="hs-identifier">makeStoreIO</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#insertFlag"><span class="hs-identifier">insertFlag</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#deleteFlag"><span class="hs-identifier">deleteFlag</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#insertSegment"><span class="hs-identifier">insertSegment</span></a></span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#deleteSegment"><span class="hs-identifier">deleteSegment</span></a></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#initializeStore"><span class="hs-identifier">initializeStore</span></a></span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#createSerializedItemDescriptor"><span class="hs-identifier">createSerializedItemDescriptor</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#FeatureKey"><span class="hs-identifier">FeatureKey</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#FeatureNamespace"><span class="hs-identifier">FeatureNamespace</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#serializeWithPlaceholder"><span class="hs-identifier">serializeWithPlaceholder</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#byteStringToVersionedData"><span class="hs-identifier">byteStringToVersionedData</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Lens'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(%~)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(^.)</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">void</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FromJSON</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ToJSON</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toJSON</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">decode</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">encode</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromStrict</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toStrict</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Function</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&amp;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Generics.Product</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HasField'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">field</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">getField</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">setField</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">atomicModifyIORef'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newIORef</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Natural</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Natural</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Clock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Clock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Monotonic</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TimeSpec</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">getTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Value</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Bool</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either.Extra</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">eitherToMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html"><span class="hs-identifier">LaunchDarkly.AesonCompat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier">KeyMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#deleteKey"><span class="hs-identifier">deleteKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#emptyObject"><span class="hs-identifier">emptyObject</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#insertKey"><span class="hs-identifier">insertKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#lookupKey"><span class="hs-identifier">lookupKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#mapMaybeValues"><span class="hs-identifier">mapMaybeValues</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier">mapValues</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#singleton"><span class="hs-identifier">singleton</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html"><span class="hs-identifier">LaunchDarkly.Server.Features</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier">Flag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier">Segment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">-- Store result not defined in terms of StoreResultM so we dont have to export.</span><span>
</span><span id="line-52"></span><span class="hs-keyword">type</span><span> </span><span id="StoreResultM"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-var">StoreResultM</span></a></span></span><span> </span><span id="local-6989586621679667670"><span class="annot"><a href="#local-6989586621679667670"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679667669"><span class="annot"><a href="#local-6989586621679667669"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679667670"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="#local-6989586621679667669"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- The result type for every `PersistentDataStore` function. Instead of throwing</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- an exception, any store related error should return `Left`. Exceptions</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- unrelated to the store should not be caught.</span><span>
</span><span id="line-58"></span><span class="hs-keyword">type</span><span> </span><span id="StoreResult"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-var">StoreResult</span></a></span></span><span> </span><span id="local-6989586621679667668"><span class="annot"><a href="#local-6989586621679667668"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="#local-6989586621679667668"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">class</span><span> </span><span id="LaunchDarklyStoreRead"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreRead"><span class="hs-identifier hs-var">LaunchDarklyStoreRead</span></a></span></span><span> </span><span id="local-6989586621679667868"><span class="annot"><a href="#local-6989586621679667868"><span class="hs-identifier hs-type">store</span></a></span></span><span> </span><span id="local-6989586621679667867"><span class="annot"><a href="#local-6989586621679667867"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-61"></span><span>    </span><span id="getFlagC"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getFlagC"><span class="hs-identifier hs-type">getFlagC</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679667868"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667867"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>    </span><span id="getSegmentC"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getSegmentC"><span class="hs-identifier hs-type">getSegmentC</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679667868"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667867"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>    </span><span id="getAllFlagsC"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getAllFlagsC"><span class="hs-identifier hs-type">getAllFlagsC</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679667868"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667867"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span>    </span><span id="getInitializedC"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getInitializedC"><span class="hs-identifier hs-type">getInitializedC</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679667868"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667867"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">class</span><span> </span><span id="LaunchDarklyStoreWrite"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreWrite"><span class="hs-identifier hs-var">LaunchDarklyStoreWrite</span></a></span></span><span> </span><span id="local-6989586621679667863"><span class="annot"><a href="#local-6989586621679667863"><span class="hs-identifier hs-type">store</span></a></span></span><span> </span><span id="local-6989586621679667862"><span class="annot"><a href="#local-6989586621679667862"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-67"></span><span>    </span><span id="storeInitializeC"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#storeInitializeC"><span class="hs-identifier hs-type">storeInitializeC</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679667863"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667862"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>    </span><span id="upsertSegmentC"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#upsertSegmentC"><span class="hs-identifier hs-type">upsertSegmentC</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679667863"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667862"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>    </span><span id="upsertFlagC"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#upsertFlagC"><span class="hs-identifier hs-type">upsertFlagC</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679667863"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667862"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span id="local-6989586621679667659"><span id="local-6989586621679667660"></span></span><span class="hs-keyword">data</span><span> </span><span id="StoreHandle"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreHandle"><span class="hs-identifier hs-var">StoreHandle</span></a></span></span><span> </span><span id="local-6989586621679667866"><span class="annot"><a href="#local-6989586621679667866"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="StoreHandle"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreHandle"><span class="hs-identifier hs-var">StoreHandle</span></a></span></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AstoreHandleGetFlag%3AStoreHandle"><span class="annot"><span class="annottext">StoreHandle m -&gt; Text -&gt; StoreResultM m (Maybe Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleGetFlag%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleGetFlag</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AstoreHandleGetSegment%3AStoreHandle"><span class="annot"><span class="annottext">StoreHandle m -&gt; Text -&gt; StoreResultM m (Maybe Segment)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleGetSegment%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleGetSegment</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AstoreHandleAllFlags%3AStoreHandle"><span class="annot"><span class="annottext">StoreHandle m -&gt; StoreResultM m (KeyMap Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleAllFlags%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleAllFlags</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AstoreHandleInitialized%3AStoreHandle"><span class="annot"><span class="annottext">StoreHandle m -&gt; StoreResultM m Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleInitialized%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleInitialized</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AstoreHandleInitialize%3AStoreHandle"><span class="annot"><span class="annottext">StoreHandle m
-&gt; KeyMap (ItemDescriptor Flag)
-&gt; KeyMap (ItemDescriptor Segment)
-&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleInitialize%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleInitialize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AstoreHandleUpsertSegment%3AStoreHandle"><span class="annot"><span class="annottext">StoreHandle m
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleUpsertSegment%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleUpsertSegment</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AstoreHandleUpsertFlag%3AStoreHandle"><span class="annot"><span class="annottext">StoreHandle m
-&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleUpsertFlag%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleUpsertFlag</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AstoreHandleExpireAll%3AStoreHandle"><span class="annot"><span class="annottext">StoreHandle m -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleExpireAll%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleExpireAll</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. StoreHandle m -&gt; Rep (StoreHandle m) x)
-&gt; (forall x. Rep (StoreHandle m) x -&gt; StoreHandle m)
-&gt; Generic (StoreHandle m)
forall x. Rep (StoreHandle m) x -&gt; StoreHandle m
forall x. StoreHandle m -&gt; Rep (StoreHandle m) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (m :: * -&gt; *) x. Rep (StoreHandle m) x -&gt; StoreHandle m
forall (m :: * -&gt; *) x. StoreHandle m -&gt; Rep (StoreHandle m) x
$cto :: forall (m :: * -&gt; *) x. Rep (StoreHandle m) x -&gt; StoreHandle m
$cfrom :: forall (m :: * -&gt; *) x. StoreHandle m -&gt; Rep (StoreHandle m) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span id="local-6989586621679667646"><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679667646"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreRead"><span class="hs-identifier hs-type">LaunchDarklyStoreRead</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreHandle"><span class="hs-identifier hs-type">StoreHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667646"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679667646"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-84"></span><span>    </span><span id="local-6989586621679667640"><span class="annot"><span class="annottext">getFlagC :: StoreHandle m -&gt; Text -&gt; StoreResultM m (Maybe Flag)
</span><a href="#local-6989586621679667640"><span class="hs-identifier hs-var hs-var hs-var hs-var">getFlagC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StoreHandle m -&gt; Text -&gt; StoreResultM m (Maybe Flag)
forall (m :: * -&gt; *).
StoreHandle m -&gt; Text -&gt; StoreResultM m (Maybe Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleGetFlag%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleGetFlag</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span id="local-6989586621679667639"><span class="annot"><span class="annottext">getSegmentC :: StoreHandle m -&gt; Text -&gt; StoreResultM m (Maybe Segment)
</span><a href="#local-6989586621679667639"><span class="hs-identifier hs-var hs-var hs-var hs-var">getSegmentC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StoreHandle m -&gt; Text -&gt; StoreResultM m (Maybe Segment)
forall (m :: * -&gt; *).
StoreHandle m -&gt; Text -&gt; StoreResultM m (Maybe Segment)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleGetSegment%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleGetSegment</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span id="local-6989586621679667638"><span class="annot"><span class="annottext">getAllFlagsC :: StoreHandle m -&gt; StoreResultM m (KeyMap Flag)
</span><a href="#local-6989586621679667638"><span class="hs-identifier hs-var hs-var hs-var hs-var">getAllFlagsC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StoreHandle m -&gt; StoreResultM m (KeyMap Flag)
forall (m :: * -&gt; *). StoreHandle m -&gt; StoreResultM m (KeyMap Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleAllFlags%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleAllFlags</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span id="local-6989586621679667637"><span class="annot"><span class="annottext">getInitializedC :: StoreHandle m -&gt; StoreResultM m Bool
</span><a href="#local-6989586621679667637"><span class="hs-identifier hs-var hs-var hs-var hs-var">getInitializedC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StoreHandle m -&gt; StoreResultM m Bool
forall (m :: * -&gt; *). StoreHandle m -&gt; StoreResultM m Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleInitialized%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleInitialized</span></a></span></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span id="local-6989586621679667636"><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679667636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreWrite"><span class="hs-identifier hs-type">LaunchDarklyStoreWrite</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreHandle"><span class="hs-identifier hs-type">StoreHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667636"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679667636"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-90"></span><span>    </span><span id="local-6989586621679667631"><span class="annot"><span class="annottext">storeInitializeC :: StoreHandle m
-&gt; KeyMap (ItemDescriptor Flag)
-&gt; KeyMap (ItemDescriptor Segment)
-&gt; StoreResultM m ()
</span><a href="#local-6989586621679667631"><span class="hs-identifier hs-var hs-var hs-var hs-var">storeInitializeC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StoreHandle m
-&gt; KeyMap (ItemDescriptor Flag)
-&gt; KeyMap (ItemDescriptor Segment)
-&gt; StoreResultM m ()
forall (m :: * -&gt; *).
StoreHandle m
-&gt; KeyMap (ItemDescriptor Flag)
-&gt; KeyMap (ItemDescriptor Segment)
-&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleInitialize%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleInitialize</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span id="local-6989586621679667630"><span class="annot"><span class="annottext">upsertSegmentC :: StoreHandle m
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
</span><a href="#local-6989586621679667630"><span class="hs-identifier hs-var hs-var hs-var hs-var">upsertSegmentC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StoreHandle m
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
forall (m :: * -&gt; *).
StoreHandle m
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleUpsertSegment%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleUpsertSegment</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621679667629"><span class="annot"><span class="annottext">upsertFlagC :: StoreHandle m
-&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
</span><a href="#local-6989586621679667629"><span class="hs-identifier hs-var hs-var hs-var hs-var">upsertFlagC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StoreHandle m
-&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
forall (m :: * -&gt; *).
StoreHandle m
-&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleUpsertFlag%3AStoreHandle"><span class="hs-identifier hs-var hs-var">storeHandleUpsertFlag</span></a></span></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span id="local-6989586621679667627"><span id="local-6989586621679667628"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#initializeStore"><span class="hs-identifier hs-type">initializeStore</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreWrite"><span class="hs-identifier hs-type">LaunchDarklyStoreWrite</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667628"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667627"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679667627"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><a href="#local-6989586621679667628"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667627"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-100"></span><span id="initializeStore"><span class="annot"><span class="annottext">initializeStore :: store -&gt; KeyMap Flag -&gt; KeyMap Segment -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#initializeStore"><span class="hs-identifier hs-var hs-var">initializeStore</span></a></span></span><span> </span><span id="local-6989586621679667626"><span class="annot"><span class="annottext">store :: store
</span><a href="#local-6989586621679667626"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667625"><span class="annot"><span class="annottext">flags :: KeyMap Flag
</span><a href="#local-6989586621679667625"><span class="hs-identifier hs-var">flags</span></a></span></span><span> </span><span id="local-6989586621679667624"><span class="annot"><span class="annottext">segments :: KeyMap Segment
</span><a href="#local-6989586621679667624"><span class="hs-identifier hs-var">segments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">store
-&gt; KeyMap (ItemDescriptor Flag)
-&gt; KeyMap (ItemDescriptor Segment)
-&gt; StoreResultM m ()
forall store (m :: * -&gt; *).
LaunchDarklyStoreWrite store m =&gt;
store
-&gt; KeyMap (ItemDescriptor Flag)
-&gt; KeyMap (ItemDescriptor Segment)
-&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#storeInitializeC"><span class="hs-identifier hs-var">storeInitializeC</span></a></span><span> </span><span class="annot"><span class="annottext">store
</span><a href="#local-6989586621679667626"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyMap Flag -&gt; KeyMap (ItemDescriptor Flag)
forall s.
HasField' &quot;version&quot; s Natural =&gt;
HashMap Text s -&gt; HashMap Text (ItemDescriptor s)
</span><a href="#local-6989586621679667623"><span class="hs-identifier hs-var">makeVersioned</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap Flag
</span><a href="#local-6989586621679667625"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyMap Segment -&gt; KeyMap (ItemDescriptor Segment)
forall s.
HasField' &quot;version&quot; s Natural =&gt;
HashMap Text s -&gt; HashMap Text (ItemDescriptor s)
</span><a href="#local-6989586621679667623"><span class="hs-identifier hs-var">makeVersioned</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap Segment
</span><a href="#local-6989586621679667624"><span class="hs-identifier hs-var">segments</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-102"></span><span>    </span><span id="local-6989586621679667623"><span class="annot"><span class="annottext">makeVersioned :: HashMap Text s -&gt; HashMap Text (ItemDescriptor s)
</span><a href="#local-6989586621679667623"><span class="hs-identifier hs-var hs-var">makeVersioned</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s -&gt; ItemDescriptor s)
-&gt; HashMap Text s -&gt; HashMap Text (ItemDescriptor s)
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679667622"><span class="annot"><span class="annottext">f :: s
</span><a href="#local-6989586621679667622"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s -&gt; Natural -&gt; ItemDescriptor s
forall a. a -&gt; Natural -&gt; ItemDescriptor a
</span><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679667622"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s -&gt; Natural
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679667622"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span id="local-6989586621679667619"><span id="local-6989586621679667620"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#insertFlag"><span class="hs-identifier hs-type">insertFlag</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreWrite"><span class="hs-identifier hs-type">LaunchDarklyStoreWrite</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667620"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667619"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679667619"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679667620"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667619"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-105"></span><span id="insertFlag"><span class="annot"><span class="annottext">insertFlag :: store -&gt; Flag -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#insertFlag"><span class="hs-identifier hs-var hs-var">insertFlag</span></a></span></span><span> </span><span id="local-6989586621679667618"><span class="annot"><span class="annottext">store :: store
</span><a href="#local-6989586621679667618"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667617"><span class="annot"><span class="annottext">flag :: Flag
</span><a href="#local-6989586621679667617"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">store -&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
forall store (m :: * -&gt; *).
LaunchDarklyStoreWrite store m =&gt;
store -&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertFlagC"><span class="hs-identifier hs-var">upsertFlagC</span></a></span><span> </span><span class="annot"><span class="annottext">store
</span><a href="#local-6989586621679667618"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Flag -&gt; Text
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;key&quot;</span></span><span> </span><span class="annot"><span class="annottext">Flag
</span><a href="#local-6989586621679667617"><span class="hs-identifier hs-var">flag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ())
-&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Flag -&gt; Natural -&gt; ItemDescriptor (Maybe Flag)
forall a. a -&gt; Natural -&gt; ItemDescriptor a
</span><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Flag -&gt; Maybe Flag
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Flag
</span><a href="#local-6989586621679667617"><span class="hs-identifier hs-var">flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Flag -&gt; Natural
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><span class="annottext">Flag
</span><a href="#local-6989586621679667617"><span class="hs-identifier hs-var">flag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span id="local-6989586621679667615"><span id="local-6989586621679667616"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#deleteFlag"><span class="hs-identifier hs-type">deleteFlag</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreWrite"><span class="hs-identifier hs-type">LaunchDarklyStoreWrite</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667616"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667615"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679667615"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679667616"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667615"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-108"></span><span id="deleteFlag"><span class="annot"><span class="annottext">deleteFlag :: store -&gt; Text -&gt; Natural -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#deleteFlag"><span class="hs-identifier hs-var hs-var">deleteFlag</span></a></span></span><span> </span><span id="local-6989586621679667614"><span class="annot"><span class="annottext">store :: store
</span><a href="#local-6989586621679667614"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667613"><span class="annot"><span class="annottext">key :: Text
</span><a href="#local-6989586621679667613"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621679667612"><span class="annot"><span class="annottext">version :: Natural
</span><a href="#local-6989586621679667612"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">store -&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
forall store (m :: * -&gt; *).
LaunchDarklyStoreWrite store m =&gt;
store -&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertFlagC"><span class="hs-identifier hs-var">upsertFlagC</span></a></span><span> </span><span class="annot"><span class="annottext">store
</span><a href="#local-6989586621679667614"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667613"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ())
-&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Flag -&gt; Natural -&gt; ItemDescriptor (Maybe Flag)
forall a. a -&gt; Natural -&gt; ItemDescriptor a
</span><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Flag
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679667612"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span id="local-6989586621679667610"><span id="local-6989586621679667611"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#insertSegment"><span class="hs-identifier hs-type">insertSegment</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreWrite"><span class="hs-identifier hs-type">LaunchDarklyStoreWrite</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667611"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667610"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679667610"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679667611"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667610"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-111"></span><span id="insertSegment"><span class="annot"><span class="annottext">insertSegment :: store -&gt; Segment -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#insertSegment"><span class="hs-identifier hs-var hs-var">insertSegment</span></a></span></span><span> </span><span id="local-6989586621679667609"><span class="annot"><span class="annottext">store :: store
</span><a href="#local-6989586621679667609"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667608"><span class="annot"><span class="annottext">segment :: Segment
</span><a href="#local-6989586621679667608"><span class="hs-identifier hs-var">segment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">store
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
forall store (m :: * -&gt; *).
LaunchDarklyStoreWrite store m =&gt;
store
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertSegmentC"><span class="hs-identifier hs-var">upsertSegmentC</span></a></span><span> </span><span class="annot"><span class="annottext">store
</span><a href="#local-6989586621679667609"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Segment -&gt; Text
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;key&quot;</span></span><span> </span><span class="annot"><span class="annottext">Segment
</span><a href="#local-6989586621679667608"><span class="hs-identifier hs-var">segment</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ())
-&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Segment -&gt; Natural -&gt; ItemDescriptor (Maybe Segment)
forall a. a -&gt; Natural -&gt; ItemDescriptor a
</span><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Segment -&gt; Maybe Segment
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Segment
</span><a href="#local-6989586621679667608"><span class="hs-identifier hs-var">segment</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Segment -&gt; Natural
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><span class="annottext">Segment
</span><a href="#local-6989586621679667608"><span class="hs-identifier hs-var">segment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span id="local-6989586621679667606"><span id="local-6989586621679667607"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#deleteSegment"><span class="hs-identifier hs-type">deleteSegment</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#LaunchDarklyStoreWrite"><span class="hs-identifier hs-type">LaunchDarklyStoreWrite</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667607"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667606"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679667606"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679667607"><span class="hs-identifier hs-type">store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResultM"><span class="hs-identifier hs-type">StoreResultM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667606"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-114"></span><span id="deleteSegment"><span class="annot"><span class="annottext">deleteSegment :: store -&gt; Text -&gt; Natural -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#deleteSegment"><span class="hs-identifier hs-var hs-var">deleteSegment</span></a></span></span><span> </span><span id="local-6989586621679667605"><span class="annot"><span class="annottext">store :: store
</span><a href="#local-6989586621679667605"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667604"><span class="annot"><span class="annottext">key :: Text
</span><a href="#local-6989586621679667604"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621679667603"><span class="annot"><span class="annottext">version :: Natural
</span><a href="#local-6989586621679667603"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">store
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
forall store (m :: * -&gt; *).
LaunchDarklyStoreWrite store m =&gt;
store
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertSegmentC"><span class="hs-identifier hs-var">upsertSegmentC</span></a></span><span> </span><span class="annot"><span class="annottext">store
</span><a href="#local-6989586621679667605"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667604"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ())
-&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Segment -&gt; Natural -&gt; ItemDescriptor (Maybe Segment)
forall a. a -&gt; Natural -&gt; ItemDescriptor a
</span><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Segment
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679667603"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#makeStoreIO"><span class="hs-identifier hs-type">makeStoreIO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#PersistentDataStore"><span class="hs-identifier hs-type">PersistentDataStore</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TimeSpec</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreHandle"><span class="hs-identifier hs-type">StoreHandle</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span id="makeStoreIO"><span class="annot"><span class="annottext">makeStoreIO :: Maybe PersistentDataStore -&gt; TimeSpec -&gt; IO (StoreHandle IO)
</span><a href="LaunchDarkly.Server.Store.Internal.html#makeStoreIO"><span class="hs-identifier hs-var hs-var">makeStoreIO</span></a></span></span><span> </span><span id="local-6989586621679667602"><span class="annot"><span class="annottext">backend :: Maybe PersistentDataStore
</span><a href="#local-6989586621679667602"><span class="hs-identifier hs-var">backend</span></a></span></span><span> </span><span id="local-6989586621679667601"><span class="annot"><span class="annottext">ttl :: TimeSpec
</span><a href="#local-6989586621679667601"><span class="hs-identifier hs-var">ttl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>    </span><span id="local-6989586621679667600"><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679667600"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="annottext">State -&gt; IO (IORef State)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span>
</span><span id="line-120"></span><span>            </span><span class="annot"><span class="annottext">$WState :: Expirable (KeyMap Flag)
-&gt; KeyMap (Expirable (CacheableItem Flag))
-&gt; KeyMap (Expirable (CacheableItem Segment))
-&gt; Expirable Bool
-&gt; State
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24WState"><span class="hs-identifier hs-type hs-type">State</span></a></span><span>
</span><span id="line-121"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:allFlags:State :: Expirable (KeyMap Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AallFlags%3AState"><span class="hs-identifier hs-var">allFlags</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KeyMap Flag -&gt; Bool -&gt; TimeSpec -&gt; Expirable (KeyMap Flag)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap Flag
forall v. KeyMap v
</span><a href="LaunchDarkly.AesonCompat.html#emptyObject"><span class="hs-identifier hs-var">emptyObject</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-122"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:features:State :: KeyMap (Expirable (CacheableItem Flag))
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Afeatures%3AState"><span class="hs-identifier hs-var">features</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KeyMap (Expirable (CacheableItem Flag))
forall v. KeyMap v
</span><a href="LaunchDarkly.AesonCompat.html#emptyObject"><span class="hs-identifier hs-var">emptyObject</span></a></span><span>
</span><span id="line-123"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:segments:State :: KeyMap (Expirable (CacheableItem Segment))
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Asegments%3AState"><span class="hs-identifier hs-var">segments</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KeyMap (Expirable (CacheableItem Segment))
forall v. KeyMap v
</span><a href="LaunchDarkly.AesonCompat.html#emptyObject"><span class="hs-identifier hs-var">emptyObject</span></a></span><span>
</span><span id="line-124"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:initialized:State :: Expirable Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Ainitialized%3AState"><span class="hs-identifier hs-var">initialized</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; TimeSpec -&gt; Expirable Bool
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-125"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679667592"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667592"><span class="hs-identifier hs-var hs-var">store</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; Maybe PersistentDataStore -&gt; TimeSpec -&gt; Store
</span><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-var">Store</span></a></span><span> </span><span class="annot"><span class="annottext">IORef State
</span><a href="#local-6989586621679667600"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe PersistentDataStore
</span><a href="#local-6989586621679667602"><span class="hs-identifier hs-var">backend</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667601"><span class="hs-identifier hs-var">ttl</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">StoreHandle IO -&gt; IO (StoreHandle IO)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-128"></span><span>        </span><span class="annot"><span class="annottext">$WStoreHandle :: forall (m :: * -&gt; *).
(Text -&gt; StoreResultM m (Maybe Flag))
-&gt; (Text -&gt; StoreResultM m (Maybe Segment))
-&gt; StoreResultM m (KeyMap Flag)
-&gt; StoreResultM m Bool
-&gt; (KeyMap (ItemDescriptor Flag)
    -&gt; KeyMap (ItemDescriptor Segment) -&gt; StoreResultM m ())
-&gt; (Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM m ())
-&gt; (Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM m ())
-&gt; StoreResultM m ()
-&gt; StoreHandle m
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24WStoreHandle"><span class="hs-identifier hs-type hs-type">StoreHandle</span></a></span><span>
</span><span id="line-129"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:storeHandleGetFlag:StoreHandle :: Text -&gt; StoreResultM IO (Maybe Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleGetFlag%3AStoreHandle"><span class="hs-identifier hs-var">storeHandleGetFlag</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store -&gt; Text -&gt; StoreResultM IO (Maybe Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#getFlag"><span class="hs-identifier hs-var">getFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667592"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-130"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:storeHandleGetSegment:StoreHandle :: Text -&gt; StoreResultM IO (Maybe Segment)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleGetSegment%3AStoreHandle"><span class="hs-identifier hs-var">storeHandleGetSegment</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store -&gt; Text -&gt; StoreResultM IO (Maybe Segment)
</span><a href="LaunchDarkly.Server.Store.Internal.html#getSegment"><span class="hs-identifier hs-var">getSegment</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667592"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-131"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:storeHandleAllFlags:StoreHandle :: StoreResultM IO (KeyMap Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleAllFlags%3AStoreHandle"><span class="hs-identifier hs-var">storeHandleAllFlags</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store -&gt; StoreResultM IO (KeyMap Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#getAllFlags"><span class="hs-identifier hs-var">getAllFlags</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667592"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-132"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:storeHandleInitialized:StoreHandle :: StoreResultM IO Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleInitialized%3AStoreHandle"><span class="hs-identifier hs-var">storeHandleInitialized</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store -&gt; StoreResultM IO Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#isInitialized"><span class="hs-identifier hs-var">isInitialized</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667592"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-133"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:storeHandleInitialize:StoreHandle :: KeyMap (ItemDescriptor Flag)
-&gt; KeyMap (ItemDescriptor Segment) -&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleInitialize%3AStoreHandle"><span class="hs-identifier hs-var">storeHandleInitialize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store
-&gt; KeyMap (ItemDescriptor Flag)
-&gt; KeyMap (ItemDescriptor Segment)
-&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#initialize"><span class="hs-identifier hs-var">initialize</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667592"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-134"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:storeHandleUpsertSegment:StoreHandle :: Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleUpsertSegment%3AStoreHandle"><span class="hs-identifier hs-var">storeHandleUpsertSegment</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertSegment"><span class="hs-identifier hs-var">upsertSegment</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667592"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-135"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:storeHandleUpsertFlag:StoreHandle :: Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleUpsertFlag%3AStoreHandle"><span class="hs-identifier hs-var">storeHandleUpsertFlag</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store -&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertFlag"><span class="hs-identifier hs-var">upsertFlag</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667592"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-136"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:storeHandleExpireAll:StoreHandle :: StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AstoreHandleExpireAll%3AStoreHandle"><span class="hs-identifier hs-var">storeHandleExpireAll</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store -&gt; IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#expireAllItems"><span class="hs-identifier hs-var">expireAllItems</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667592"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; StoreResultM IO () -&gt; StoreResultM IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either Text () -&gt; StoreResultM IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text () -&gt; StoreResultM IO ())
-&gt; Either Text () -&gt; StoreResultM IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either Text ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span id="local-6989586621679667587"><span id="local-6989586621679667588"></span></span><span class="hs-keyword">data</span><span> </span><span id="Expirable"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span></span><span> </span><span id="local-6989586621679667829"><span class="annot"><a href="#local-6989586621679667829"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Expirable"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3Avalue%3AExpirable"><span class="annot"><span class="annottext">Expirable a -&gt; a
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Avalue%3AExpirable"><span class="hs-identifier hs-var hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679667829"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AforceExpire%3AExpirable"><span class="annot"><span class="annottext">Expirable a -&gt; Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AforceExpire%3AExpirable"><span class="hs-identifier hs-var hs-var">forceExpire</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AupdatedOn%3AExpirable"><span class="annot"><span class="annottext">Expirable a -&gt; TimeSpec
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AupdatedOn%3AExpirable"><span class="hs-identifier hs-var hs-var">updatedOn</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">TimeSpec</span></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. Expirable a -&gt; Rep (Expirable a) x)
-&gt; (forall x. Rep (Expirable a) x -&gt; Expirable a)
-&gt; Generic (Expirable a)
forall x. Rep (Expirable a) x -&gt; Expirable a
forall x. Expirable a -&gt; Rep (Expirable a) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall a x. Rep (Expirable a) x -&gt; Expirable a
forall a x. Expirable a -&gt; Rep (Expirable a) x
$cto :: forall a x. Rep (Expirable a) x -&gt; Expirable a
$cfrom :: forall a x. Expirable a -&gt; Rep (Expirable a) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span id="local-6989586621679667580"><span id="local-6989586621679667581"></span></span><span class="hs-keyword">data</span><span> </span><span id="ItemDescriptor"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span></span><span> </span><span id="local-6989586621679667854"><span class="annot"><a href="#local-6989586621679667854"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ItemDescriptor"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span></span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3Avalue%3AItemDescriptor"><span class="annot"><span class="annottext">ItemDescriptor a -&gt; a
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Avalue%3AItemDescriptor"><span class="hs-identifier hs-var hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679667854"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Aversion%3AItemDescriptor"><span class="annot"><span class="annottext">ItemDescriptor a -&gt; Natural
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aversion%3AItemDescriptor"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. ItemDescriptor a -&gt; Rep (ItemDescriptor a) x)
-&gt; (forall x. Rep (ItemDescriptor a) x -&gt; ItemDescriptor a)
-&gt; Generic (ItemDescriptor a)
forall x. Rep (ItemDescriptor a) x -&gt; ItemDescriptor a
forall x. ItemDescriptor a -&gt; Rep (ItemDescriptor a) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall a x. Rep (ItemDescriptor a) x -&gt; ItemDescriptor a
forall a x. ItemDescriptor a -&gt; Rep (ItemDescriptor a) x
$cto :: forall a x. Rep (ItemDescriptor a) x -&gt; ItemDescriptor a
$cfrom :: forall a x. ItemDescriptor a -&gt; Rep (ItemDescriptor a) x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">-- The CacheableItem is used to store results from a persistent store.</span><span>
</span><span id="line-153"></span><span class="hs-comment">--</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- The type is a Maybe because it is possible that a persistent store will not</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- have a record of a flag requested. We can store that result as a Nothing and</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- prevent subsequent evaluations from reaching across the network.</span><span>
</span><span id="line-157"></span><span class="hs-keyword">type</span><span> </span><span id="CacheableItem"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#CacheableItem"><span class="hs-identifier hs-var">CacheableItem</span></a></span></span><span> </span><span id="local-6989586621679667575"><span class="annot"><a href="#local-6989586621679667575"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679667575"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span id="local-6989586621679667573"><span id="local-6989586621679667574"></span></span><span class="hs-keyword">data</span><span> </span><span id="State"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="State"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AallFlags%3AState"><span class="annot"><span class="annottext">State -&gt; Expirable (KeyMap Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AallFlags%3AState"><span class="hs-identifier hs-var hs-var">allFlags</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-type">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Afeatures%3AState"><span class="annot"><span class="annottext">State -&gt; KeyMap (Expirable (CacheableItem Flag))
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Afeatures%3AState"><span class="hs-identifier hs-var hs-var">features</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-type">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#CacheableItem"><span class="hs-identifier hs-type">CacheableItem</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Asegments%3AState"><span class="annot"><span class="annottext">State -&gt; KeyMap (Expirable (CacheableItem Segment))
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Asegments%3AState"><span class="hs-identifier hs-var hs-var">segments</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-type">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#CacheableItem"><span class="hs-identifier hs-type">CacheableItem</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Ainitialized%3AState"><span class="annot"><span class="annottext">State -&gt; Expirable Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Ainitialized%3AState"><span class="hs-identifier hs-var hs-var">initialized</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-type">Expirable</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. State -&gt; Rep State x)
-&gt; (forall x. Rep State x -&gt; State) -&gt; Generic State
forall x. Rep State x -&gt; State
forall x. State -&gt; Rep State x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep State x -&gt; State
$cfrom :: forall x. State -&gt; Rep State x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="hs-comment">-- | Represents the key for a given feature.</span><span>
</span><span id="line-168"></span><span class="hs-keyword">type</span><span> </span><span id="FeatureKey"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#FeatureKey"><span class="hs-identifier hs-var">FeatureKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="hs-comment">-- | Represents a namespace such as features or segments</span><span>
</span><span id="line-171"></span><span class="hs-keyword">type</span><span> </span><span id="FeatureNamespace"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#FeatureNamespace"><span class="hs-identifier hs-var">FeatureNamespace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-comment">-- | The interface implemented by external stores for use by the SDK.</span><span>
</span><span id="line-174"></span><span class="hs-keyword">data</span><span> </span><span id="PersistentDataStore"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#PersistentDataStore"><span class="hs-identifier hs-var">PersistentDataStore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PersistentDataStore"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#PersistentDataStore"><span class="hs-identifier hs-var">PersistentDataStore</span></a></span></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3ApersistentDataStoreAllFeatures%3APersistentDataStore"><span class="annot"><span class="annottext">PersistentDataStore
-&gt; Text -&gt; StoreResult (KeyMap SerializedItemDescriptor)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreAllFeatures%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreAllFeatures</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#FeatureNamespace"><span class="hs-identifier hs-type">FeatureNamespace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-comment">-- ^ A map of all features in a given namespace including deleted.</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3ApersistentDataStoreGetFeature%3APersistentDataStore"><span class="annot"><span class="annottext">PersistentDataStore
-&gt; Text -&gt; Text -&gt; StoreResult (Maybe SerializedItemDescriptor)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreGetFeature%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreGetFeature</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#FeatureNamespace"><span class="hs-identifier hs-type">FeatureNamespace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#FeatureKey"><span class="hs-identifier hs-type">FeatureKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-comment">-- ^ Return the value of a key in a namespace.</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3ApersistentDataStoreUpsertFeature%3APersistentDataStore"><span class="annot"><span class="annottext">PersistentDataStore
-&gt; Text -&gt; Text -&gt; SerializedItemDescriptor -&gt; StoreResultM IO Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreUpsertFeature%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreUpsertFeature</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#FeatureNamespace"><span class="hs-identifier hs-type">FeatureNamespace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#FeatureKey"><span class="hs-identifier hs-type">FeatureKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-comment">-- ^ Upsert a given feature. Versions should be compared before upsert.</span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-comment">-- The result should indicate if the feature was replaced or not.</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3ApersistentDataStoreIsInitialized%3APersistentDataStore"><span class="annot"><span class="annottext">PersistentDataStore -&gt; StoreResultM IO Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreIsInitialized%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreIsInitialized</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-comment">-- ^ Checks if the external store has been initialized, which may</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-comment">-- have been done by another instance of the SDK.</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3ApersistentDataStoreInitialize%3APersistentDataStore"><span class="annot"><span class="annottext">PersistentDataStore
-&gt; KeyMap (KeyMap SerializedItemDescriptor) -&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreInitialize%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreInitialize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">-- ^ A map of namespaces, and items in namespaces. The entire store state</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">-- should be replaced with these values.</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- | A record representing an object that can be persisted in an external store.</span><span>
</span><span id="line-191"></span><span id="local-6989586621679667563"><span id="local-6989586621679667564"></span></span><span class="hs-keyword">data</span><span> </span><span id="SerializedItemDescriptor"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-var">SerializedItemDescriptor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SerializedItemDescriptor"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-var">SerializedItemDescriptor</span></a></span></span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3Aitem%3ASerializedItemDescriptor"><span class="annot"><span class="annottext">SerializedItemDescriptor -&gt; Maybe ByteString
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aitem%3ASerializedItemDescriptor"><span class="hs-identifier hs-var hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-comment">-- ^ A serialized item. If the item is deleted or does not exist this</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-comment">-- should be `Nothing`.</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Aversion%3ASerializedItemDescriptor"><span class="annot"><span class="annottext">SerializedItemDescriptor -&gt; Natural
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aversion%3ASerializedItemDescriptor"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-comment">-- ^ The version of a given item. If the item does not exist this should</span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-comment">-- be zero.</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Adeleted%3ASerializedItemDescriptor"><span class="annot"><span class="annottext">SerializedItemDescriptor -&gt; Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Adeleted%3ASerializedItemDescriptor"><span class="hs-identifier hs-var hs-var">deleted</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-comment">-- ^ True if this is a placeholder (tombstone) for a deleted item.</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x.
 SerializedItemDescriptor -&gt; Rep SerializedItemDescriptor x)
-&gt; (forall x.
    Rep SerializedItemDescriptor x -&gt; SerializedItemDescriptor)
-&gt; Generic SerializedItemDescriptor
forall x.
Rep SerializedItemDescriptor x -&gt; SerializedItemDescriptor
forall x.
SerializedItemDescriptor -&gt; Rep SerializedItemDescriptor x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x.
Rep SerializedItemDescriptor x -&gt; SerializedItemDescriptor
$cfrom :: forall x.
SerializedItemDescriptor -&gt; Rep SerializedItemDescriptor x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679667553"><span id="local-6989586621679667555"><span class="annot"><span class="annottext">SerializedItemDescriptor -&gt; SerializedItemDescriptor -&gt; Bool
(SerializedItemDescriptor -&gt; SerializedItemDescriptor -&gt; Bool)
-&gt; (SerializedItemDescriptor -&gt; SerializedItemDescriptor -&gt; Bool)
-&gt; Eq SerializedItemDescriptor
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SerializedItemDescriptor -&gt; SerializedItemDescriptor -&gt; Bool
$c/= :: SerializedItemDescriptor -&gt; SerializedItemDescriptor -&gt; Bool
== :: SerializedItemDescriptor -&gt; SerializedItemDescriptor -&gt; Bool
$c== :: SerializedItemDescriptor -&gt; SerializedItemDescriptor -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679667546"><span id="local-6989586621679667548"><span id="local-6989586621679667550"><span class="annot"><span class="annottext">Int -&gt; SerializedItemDescriptor -&gt; ShowS
[SerializedItemDescriptor] -&gt; ShowS
SerializedItemDescriptor -&gt; String
(Int -&gt; SerializedItemDescriptor -&gt; ShowS)
-&gt; (SerializedItemDescriptor -&gt; String)
-&gt; ([SerializedItemDescriptor] -&gt; ShowS)
-&gt; Show SerializedItemDescriptor
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SerializedItemDescriptor] -&gt; ShowS
$cshowList :: [SerializedItemDescriptor] -&gt; ShowS
show :: SerializedItemDescriptor -&gt; String
$cshow :: SerializedItemDescriptor -&gt; String
showsPrec :: Int -&gt; SerializedItemDescriptor -&gt; ShowS
$cshowsPrec :: Int -&gt; SerializedItemDescriptor -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- Generate a 'ByteString' representation of the 'SerializedItemDescriptor'.</span><span>
</span><span id="line-205"></span><span class="hs-comment">--</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- If the 'SerializedItemDescriptor' has either a 'Nothing' value, or is marked</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- as deleted, the ByteString representation will be a tombstone marker containing the version and deletion status.</span><span>
</span><span id="line-208"></span><span class="hs-comment">--</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- Otherwise, the internal item representation is returned.</span><span>
</span><span id="line-210"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#serializeWithPlaceholder"><span class="hs-identifier hs-type">serializeWithPlaceholder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-211"></span><span id="serializeWithPlaceholder"><span class="annot"><span class="annottext">serializeWithPlaceholder :: SerializedItemDescriptor -&gt; ByteString
</span><a href="LaunchDarkly.Server.Store.Internal.html#serializeWithPlaceholder"><span class="hs-identifier hs-var hs-var">serializeWithPlaceholder</span></a></span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:item:SerializedItemDescriptor :: SerializedItemDescriptor -&gt; Maybe ByteString
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aitem%3ASerializedItemDescriptor"><span class="hs-identifier hs-var">item</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:version:SerializedItemDescriptor :: SerializedItemDescriptor -&gt; Natural
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aversion%3ASerializedItemDescriptor"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679667544"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679667544"><span class="hs-identifier hs-var">version</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; ByteString
</span><a href="LaunchDarkly.Server.Store.Internal.html#tombstonePlaceholder"><span class="hs-identifier hs-var">tombstonePlaceholder</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679667544"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-212"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#serializeWithPlaceholder"><span class="hs-identifier hs-var">serializeWithPlaceholder</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:deleted:SerializedItemDescriptor :: SerializedItemDescriptor -&gt; Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Adeleted%3ASerializedItemDescriptor"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:version:SerializedItemDescriptor :: SerializedItemDescriptor -&gt; Natural
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aversion%3ASerializedItemDescriptor"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679667542"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679667542"><span class="hs-identifier hs-var">version</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; ByteString
</span><a href="LaunchDarkly.Server.Store.Internal.html#tombstonePlaceholder"><span class="hs-identifier hs-var">tombstonePlaceholder</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679667542"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-213"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#serializeWithPlaceholder"><span class="hs-identifier hs-var">serializeWithPlaceholder</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:item:SerializedItemDescriptor :: SerializedItemDescriptor -&gt; Maybe ByteString
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aitem%3ASerializedItemDescriptor"><span class="hs-identifier hs-var">item</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667541"><span class="annot"><span class="annottext">item :: ByteString
</span><a href="#local-6989586621679667541"><span class="hs-identifier hs-var">item</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679667541"><span class="hs-identifier hs-var">item</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-comment">-- Generate the tombstone placeholder ByteString representation.</span><span>
</span><span id="line-216"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#tombstonePlaceholder"><span class="hs-identifier hs-type">tombstonePlaceholder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-217"></span><span id="tombstonePlaceholder"><span class="annot"><span class="annottext">tombstonePlaceholder :: Natural -&gt; ByteString
</span><a href="LaunchDarkly.Server.Store.Internal.html#tombstonePlaceholder"><span class="hs-identifier hs-var hs-var">tombstonePlaceholder</span></a></span></span><span> </span><span id="local-6989586621679667540"><span class="annot"><span class="annottext">version :: Natural
</span><a href="#local-6989586621679667540"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value -&gt; HashMap Text Value
forall v. Text -&gt; v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#singleton"><span class="hs-identifier hs-var">singleton</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;deleted&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Value
</span><span class="hs-identifier hs-var">Bool</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Text Value
-&gt; (HashMap Text Value -&gt; HashMap Text Value) -&gt; HashMap Text Value
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value -&gt; HashMap Text Value -&gt; HashMap Text Value
forall v. Text -&gt; v -&gt; HashMap Text v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#insertKey"><span class="hs-identifier hs-var">insertKey</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679667540"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Text Value
-&gt; (HashMap Text Value -&gt; ByteString) -&gt; ByteString
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">HashMap Text Value -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">encode</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; (ByteString -&gt; ByteString) -&gt; ByteString
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">toStrict</span></span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- Partially decode the provided ByteString into a 'VersionedData' struct.</span><span>
</span><span id="line-221"></span><span class="hs-comment">--</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- This is useful for persistent stores who need to perform version comparsions</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- before persisting data.</span><span>
</span><span id="line-224"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#byteStringToVersionedData"><span class="hs-identifier hs-type">byteStringToVersionedData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#VersionedData"><span class="hs-identifier hs-type">VersionedData</span></a></span><span>
</span><span id="line-225"></span><span id="byteStringToVersionedData"><span class="annot"><span class="annottext">byteStringToVersionedData :: ByteString -&gt; Maybe VersionedData
</span><a href="LaunchDarkly.Server.Store.Internal.html#byteStringToVersionedData"><span class="hs-identifier hs-var hs-var">byteStringToVersionedData</span></a></span></span><span> </span><span id="local-6989586621679667539"><span class="annot"><span class="annottext">byteString :: ByteString
</span><a href="#local-6989586621679667539"><span class="hs-identifier hs-var">byteString</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe VersionedData
forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><span class="hs-identifier hs-var">decode</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Maybe VersionedData)
-&gt; ByteString -&gt; Maybe VersionedData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">fromStrict</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679667539"><span class="hs-identifier hs-var">byteString</span></a></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span id="local-6989586621679667537"><span id="local-6989586621679667538"></span></span><span class="hs-keyword">data</span><span> </span><span id="VersionedData"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#VersionedData"><span class="hs-identifier hs-var">VersionedData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="VersionedData"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#VersionedData"><span class="hs-identifier hs-var">VersionedData</span></a></span></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3Aversion%3AVersionedData"><span class="annot"><span class="annottext">VersionedData -&gt; Natural
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aversion%3AVersionedData"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Adeleted%3AVersionedData"><span class="annot"><span class="annottext">VersionedData -&gt; Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Adeleted%3AVersionedData"><span class="hs-identifier hs-var hs-var">deleted</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. VersionedData -&gt; Rep VersionedData x)
-&gt; (forall x. Rep VersionedData x -&gt; VersionedData)
-&gt; Generic VersionedData
forall x. Rep VersionedData x -&gt; VersionedData
forall x. VersionedData -&gt; Rep VersionedData x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep VersionedData x -&gt; VersionedData
$cfrom :: forall x. VersionedData -&gt; Rep VersionedData x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679667524"><span id="local-6989586621679667526"><span id="local-6989586621679667528"><span id="local-6989586621679667530"><span class="annot"><span class="annottext">[VersionedData] -&gt; Encoding
[VersionedData] -&gt; Value
VersionedData -&gt; Encoding
VersionedData -&gt; Value
(VersionedData -&gt; Value)
-&gt; (VersionedData -&gt; Encoding)
-&gt; ([VersionedData] -&gt; Value)
-&gt; ([VersionedData] -&gt; Encoding)
-&gt; ToJSON VersionedData
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [VersionedData] -&gt; Encoding
$ctoEncodingList :: [VersionedData] -&gt; Encoding
toJSONList :: [VersionedData] -&gt; Value
$ctoJSONList :: [VersionedData] -&gt; Value
toEncoding :: VersionedData -&gt; Encoding
$ctoEncoding :: VersionedData -&gt; Encoding
toJSON :: VersionedData -&gt; Value
$ctoJSON :: VersionedData -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679667519"><span id="local-6989586621679667521"><span class="annot"><span class="annottext">Value -&gt; Parser [VersionedData]
Value -&gt; Parser VersionedData
(Value -&gt; Parser VersionedData)
-&gt; (Value -&gt; Parser [VersionedData]) -&gt; FromJSON VersionedData
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [VersionedData]
$cparseJSONList :: Value -&gt; Parser [VersionedData]
parseJSON :: Value -&gt; Parser VersionedData
$cparseJSON :: Value -&gt; Parser VersionedData
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span id="local-6989586621679667516"><span id="local-6989586621679667517"></span></span><span class="hs-keyword">data</span><span> </span><span id="Store"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-var">Store</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Store"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-var">Store</span></a></span></span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="%24sel%3Astate%3AStore"><span class="annot"><span class="annottext">Store -&gt; IORef State
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Astate%3AStore"><span class="hs-identifier hs-var hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#State"><span class="hs-identifier hs-type">State</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Abackend%3AStore"><span class="annot"><span class="annottext">Store -&gt; Maybe PersistentDataStore
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Abackend%3AStore"><span class="hs-identifier hs-var hs-var">backend</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#PersistentDataStore"><span class="hs-identifier hs-type">PersistentDataStore</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AtimeToLive%3AStore"><span class="annot"><span class="annottext">Store -&gt; TimeSpec
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3AtimeToLive%3AStore"><span class="hs-identifier hs-var hs-var">timeToLive</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">TimeSpec</span></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. Store -&gt; Rep Store x)
-&gt; (forall x. Rep Store x -&gt; Store) -&gt; Generic Store
forall x. Rep Store x -&gt; Store
forall x. Store -&gt; Rep Store x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep Store x -&gt; Store
$cfrom :: forall x. Store -&gt; Rep Store x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#expireAllItems"><span class="hs-identifier hs-type">expireAllItems</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span id="expireAllItems"><span class="annot"><span class="annottext">expireAllItems :: Store -&gt; IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#expireAllItems"><span class="hs-identifier hs-var hs-var">expireAllItems</span></a></span></span><span> </span><span id="local-6989586621679667510"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667510"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667510"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, ())) -&gt; IO ())
-&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679667509"><span class="annot"><span class="annottext">state :: State
</span><a href="#local-6989586621679667509"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; (State, ())) -&gt; State -&gt; (State, ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667509"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-244"></span><span>            </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;allFlags&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;allFlags&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Expirable (KeyMap Flag) -&gt; Identity (Expirable (KeyMap Flag)))
 -&gt; State -&gt; Identity State)
-&gt; (Expirable (KeyMap Flag) -&gt; Expirable (KeyMap Flag))
-&gt; State
-&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">Expirable (KeyMap Flag) -&gt; Expirable (KeyMap Flag)
forall s. HasField' &quot;forceExpire&quot; s Bool =&gt; s -&gt; s
</span><a href="#local-6989586621679667508"><span class="hs-identifier hs-var">expire</span></a></span><span>
</span><span id="line-245"></span><span>            </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;initialized&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;initialized&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Expirable Bool -&gt; Identity (Expirable Bool))
 -&gt; State -&gt; Identity State)
-&gt; (Expirable Bool -&gt; Expirable Bool) -&gt; State -&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">Expirable Bool -&gt; Expirable Bool
forall s. HasField' &quot;forceExpire&quot; s Bool =&gt; s -&gt; s
</span><a href="#local-6989586621679667508"><span class="hs-identifier hs-var">expire</span></a></span><span>
</span><span id="line-246"></span><span>            </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;features&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;features&quot;</span></span><span> </span><span class="annot"><span class="annottext">((KeyMap (Expirable (CacheableItem Flag))
  -&gt; Identity (KeyMap (Expirable (CacheableItem Flag))))
 -&gt; State -&gt; Identity State)
-&gt; (KeyMap (Expirable (CacheableItem Flag))
    -&gt; KeyMap (Expirable (CacheableItem Flag)))
-&gt; State
-&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">(Expirable (CacheableItem Flag) -&gt; Expirable (CacheableItem Flag))
-&gt; KeyMap (Expirable (CacheableItem Flag))
-&gt; KeyMap (Expirable (CacheableItem Flag))
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="annot"><span class="annottext">Expirable (CacheableItem Flag) -&gt; Expirable (CacheableItem Flag)
forall s. HasField' &quot;forceExpire&quot; s Bool =&gt; s -&gt; s
</span><a href="#local-6989586621679667508"><span class="hs-identifier hs-var">expire</span></a></span><span>
</span><span id="line-247"></span><span>            </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;segments&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;segments&quot;</span></span><span> </span><span class="annot"><span class="annottext">((KeyMap (Expirable (CacheableItem Segment))
  -&gt; Identity (KeyMap (Expirable (CacheableItem Segment))))
 -&gt; State -&gt; Identity State)
-&gt; (KeyMap (Expirable (CacheableItem Segment))
    -&gt; KeyMap (Expirable (CacheableItem Segment)))
-&gt; State
-&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">(Expirable (CacheableItem Segment)
 -&gt; Expirable (CacheableItem Segment))
-&gt; KeyMap (Expirable (CacheableItem Segment))
-&gt; KeyMap (Expirable (CacheableItem Segment))
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="annot"><span class="annottext">Expirable (CacheableItem Segment)
-&gt; Expirable (CacheableItem Segment)
forall s. HasField' &quot;forceExpire&quot; s Bool =&gt; s -&gt; s
</span><a href="#local-6989586621679667508"><span class="hs-identifier hs-var">expire</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-249"></span><span>    </span><span id="local-6989586621679667508"><span class="annot"><span class="annottext">expire :: s -&gt; s
</span><a href="#local-6989586621679667508"><span class="hs-identifier hs-var hs-var">expire</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; s -&gt; s
forall (f :: Symbol) s a. HasField' f s a =&gt; a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">setField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;forceExpire&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span id="local-6989586621679667736"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#isExpired"><span class="hs-identifier hs-type">isExpired</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TimeSpec</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-type">Expirable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667736"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-252"></span><span id="isExpired"><span class="annot"><span class="annottext">isExpired :: Store -&gt; TimeSpec -&gt; Expirable a -&gt; Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#isExpired"><span class="hs-identifier hs-var hs-var">isExpired</span></a></span></span><span> </span><span id="local-6989586621679667506"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667506"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667505"><span class="annot"><span class="annottext">now :: TimeSpec
</span><a href="#local-6989586621679667505"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span id="local-6989586621679667504"><span class="annot"><span class="annottext">item :: Expirable a
</span><a href="#local-6989586621679667504"><span class="hs-identifier hs-var">item</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe PersistentDataStore -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe PersistentDataStore -&gt; Bool)
-&gt; Maybe PersistentDataStore -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Store -&gt; Maybe PersistentDataStore
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;backend&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667506"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expirable a -&gt; Bool
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;forceExpire&quot;</span></span><span> </span><span class="annot"><span class="annottext">Expirable a
</span><a href="#local-6989586621679667504"><span class="hs-identifier hs-var">item</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; TimeSpec
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;timeToLive&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667506"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TimeSpec -&gt; TimeSpec -&gt; TimeSpec
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expirable a -&gt; TimeSpec
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;updatedOn&quot;</span></span><span> </span><span class="annot"><span class="annottext">Expirable a
</span><a href="#local-6989586621679667504"><span class="hs-identifier hs-var">item</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TimeSpec -&gt; TimeSpec -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667505"><span class="hs-identifier hs-var">now</span></a></span><span>
</span><span id="line-256"></span><span>           </span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getMonotonicTime"><span class="hs-identifier hs-type">getMonotonicTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TimeSpec</span></span><span>
</span><span id="line-259"></span><span id="getMonotonicTime"><span class="annot"><span class="annottext">getMonotonicTime :: IO TimeSpec
</span><a href="LaunchDarkly.Server.Store.Internal.html#getMonotonicTime"><span class="hs-identifier hs-var hs-var">getMonotonicTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Clock -&gt; IO TimeSpec
</span><span class="hs-identifier hs-var">getTime</span></span><span> </span><span class="annot"><span class="annottext">Clock
</span><span class="hs-identifier hs-var">Monotonic</span></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#initialize"><span class="hs-identifier hs-type">initialize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span id="initialize"><span class="annot"><span class="annottext">initialize :: Store
-&gt; KeyMap (ItemDescriptor Flag)
-&gt; KeyMap (ItemDescriptor Segment)
-&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#initialize"><span class="hs-identifier hs-var hs-var">initialize</span></a></span></span><span> </span><span id="local-6989586621679667498"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667498"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667497"><span class="annot"><span class="annottext">flags :: KeyMap (ItemDescriptor Flag)
</span><a href="#local-6989586621679667497"><span class="hs-identifier hs-var">flags</span></a></span></span><span> </span><span id="local-6989586621679667496"><span class="annot"><span class="annottext">segments :: KeyMap (ItemDescriptor Segment)
</span><a href="#local-6989586621679667496"><span class="hs-identifier hs-var">segments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Store -&gt; Maybe PersistentDataStore
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;backend&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667498"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-263"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667498"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, ())) -&gt; IO ())
-&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679667495"><span class="annot"><span class="annottext">state :: State
</span><a href="#local-6989586621679667495"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-265"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; (State, ())) -&gt; State -&gt; (State, ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-266"></span><span>                </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667495"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-267"></span><span>                    </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">KeyMap (Expirable (CacheableItem Flag)) -&gt; State -&gt; State
forall (f :: Symbol) s a. HasField' f s a =&gt; a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">setField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;features&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Flag) -&gt; Expirable (CacheableItem Flag))
-&gt; HashMap Text (ItemDescriptor (Maybe Flag))
-&gt; KeyMap (Expirable (CacheableItem Flag))
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679667494"><span class="annot"><span class="annottext">f :: ItemDescriptor (Maybe Flag)
</span><a href="#local-6989586621679667494"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CacheableItem Flag
-&gt; Bool -&gt; TimeSpec -&gt; Expirable (CacheableItem Flag)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Flag) -&gt; CacheableItem Flag
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Flag)
</span><a href="#local-6989586621679667494"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(HashMap Text (ItemDescriptor (Maybe Flag))
 -&gt; KeyMap (Expirable (CacheableItem Flag)))
-&gt; HashMap Text (ItemDescriptor (Maybe Flag))
-&gt; KeyMap (Expirable (CacheableItem Flag))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyMap (ItemDescriptor Flag)
-&gt; HashMap Text (ItemDescriptor (Maybe Flag))
forall s v2 a.
HasField &quot;value&quot; s v2 a (Maybe a) =&gt;
HashMap Text s -&gt; HashMap Text v2
</span><a href="#local-6989586621679667493"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap (ItemDescriptor Flag)
</span><a href="#local-6989586621679667497"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>                    </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">KeyMap (Expirable (CacheableItem Segment)) -&gt; State -&gt; State
forall (f :: Symbol) s a. HasField' f s a =&gt; a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">setField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;segments&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Segment)
 -&gt; Expirable (CacheableItem Segment))
-&gt; HashMap Text (ItemDescriptor (Maybe Segment))
-&gt; KeyMap (Expirable (CacheableItem Segment))
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679667492"><span class="annot"><span class="annottext">f :: ItemDescriptor (Maybe Segment)
</span><a href="#local-6989586621679667492"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CacheableItem Segment
-&gt; Bool -&gt; TimeSpec -&gt; Expirable (CacheableItem Segment)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Segment) -&gt; CacheableItem Segment
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Segment)
</span><a href="#local-6989586621679667492"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(HashMap Text (ItemDescriptor (Maybe Segment))
 -&gt; KeyMap (Expirable (CacheableItem Segment)))
-&gt; HashMap Text (ItemDescriptor (Maybe Segment))
-&gt; KeyMap (Expirable (CacheableItem Segment))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyMap (ItemDescriptor Segment)
-&gt; HashMap Text (ItemDescriptor (Maybe Segment))
forall s v2 a.
HasField &quot;value&quot; s v2 a (Maybe a) =&gt;
HashMap Text s -&gt; HashMap Text v2
</span><a href="#local-6989586621679667493"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap (ItemDescriptor Segment)
</span><a href="#local-6989586621679667496"><span class="hs-identifier hs-var">segments</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>                    </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Expirable (KeyMap Flag) -&gt; State -&gt; State
forall (f :: Symbol) s a. HasField' f s a =&gt; a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">setField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;allFlags&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyMap Flag -&gt; Bool -&gt; TimeSpec -&gt; Expirable (KeyMap Flag)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ItemDescriptor Flag -&gt; Flag)
-&gt; KeyMap (ItemDescriptor Flag) -&gt; KeyMap Flag
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a s. HasField' &quot;value&quot; s a =&gt; s -&gt; a
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KeyMap (ItemDescriptor Flag)
</span><a href="#local-6989586621679667497"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>                    </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Expirable Bool -&gt; State -&gt; State
forall (f :: Symbol) s a. HasField' f s a =&gt; a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">setField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;initialized&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; TimeSpec -&gt; Expirable Bool
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>        </span><span class="annot"><span class="annottext">Either Text () -&gt; StoreResultM IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text () -&gt; StoreResultM IO ())
-&gt; Either Text () -&gt; StoreResultM IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either Text ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667491"><span class="annot"><span class="annottext">backend :: PersistentDataStore
</span><a href="#local-6989586621679667491"><span class="hs-identifier hs-var">backend</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-273"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PersistentDataStore
-&gt; KeyMap (KeyMap SerializedItemDescriptor) -&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreInitialize%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreInitialize</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentDataStore
</span><a href="#local-6989586621679667491"><span class="hs-identifier hs-var">backend</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KeyMap (KeyMap SerializedItemDescriptor)
</span><a href="#local-6989586621679667490"><span class="hs-identifier hs-var">serializedItemMap</span></a></span><span> </span><span class="annot"><span class="annottext">StoreResultM IO ()
-&gt; (Either Text () -&gt; StoreResultM IO ()) -&gt; StoreResultM IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-274"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679667489"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679667489"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text () -&gt; StoreResultM IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text () -&gt; StoreResultM IO ())
-&gt; Either Text () -&gt; StoreResultM IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667489"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-275"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Store -&gt; IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#expireAllItems"><span class="hs-identifier hs-var">expireAllItems</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667498"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; StoreResultM IO () -&gt; StoreResultM IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Either Text () -&gt; StoreResultM IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; Either Text ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-277"></span><span>    </span><span id="local-6989586621679667490"><span class="annot"><span class="annottext">serializedItemMap :: KeyMap (KeyMap SerializedItemDescriptor)
</span><a href="#local-6989586621679667490"><span class="hs-identifier hs-var hs-var">serializedItemMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-278"></span><span>        </span><span class="annot"><span class="annottext">KeyMap (KeyMap SerializedItemDescriptor)
forall v. KeyMap v
</span><a href="LaunchDarkly.AesonCompat.html#emptyObject"><span class="hs-identifier hs-var">emptyObject</span></a></span><span>
</span><span id="line-279"></span><span>            </span><span class="annot"><span class="annottext">KeyMap (KeyMap SerializedItemDescriptor)
-&gt; (KeyMap (KeyMap SerializedItemDescriptor)
    -&gt; KeyMap (KeyMap SerializedItemDescriptor))
-&gt; KeyMap (KeyMap SerializedItemDescriptor)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Text
-&gt; KeyMap SerializedItemDescriptor
-&gt; KeyMap (KeyMap SerializedItemDescriptor)
-&gt; KeyMap (KeyMap SerializedItemDescriptor)
forall v. Text -&gt; v -&gt; HashMap Text v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#insertKey"><span class="hs-identifier hs-var">insertKey</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;features&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Flag) -&gt; SerializedItemDescriptor)
-&gt; HashMap Text (ItemDescriptor (Maybe Flag))
-&gt; KeyMap SerializedItemDescriptor
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Flag) -&gt; SerializedItemDescriptor
forall a.
ToJSON a =&gt;
ItemDescriptor (Maybe a) -&gt; SerializedItemDescriptor
</span><a href="LaunchDarkly.Server.Store.Internal.html#createSerializedItemDescriptor"><span class="hs-identifier hs-var">createSerializedItemDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap Text (ItemDescriptor (Maybe Flag))
 -&gt; KeyMap SerializedItemDescriptor)
-&gt; HashMap Text (ItemDescriptor (Maybe Flag))
-&gt; KeyMap SerializedItemDescriptor
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyMap (ItemDescriptor Flag)
-&gt; HashMap Text (ItemDescriptor (Maybe Flag))
forall s v2 a.
HasField &quot;value&quot; s v2 a (Maybe a) =&gt;
HashMap Text s -&gt; HashMap Text v2
</span><a href="#local-6989586621679667493"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap (ItemDescriptor Flag)
</span><a href="#local-6989586621679667497"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>            </span><span class="annot"><span class="annottext">KeyMap (KeyMap SerializedItemDescriptor)
-&gt; (KeyMap (KeyMap SerializedItemDescriptor)
    -&gt; KeyMap (KeyMap SerializedItemDescriptor))
-&gt; KeyMap (KeyMap SerializedItemDescriptor)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Text
-&gt; KeyMap SerializedItemDescriptor
-&gt; KeyMap (KeyMap SerializedItemDescriptor)
-&gt; KeyMap (KeyMap SerializedItemDescriptor)
forall v. Text -&gt; v -&gt; HashMap Text v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#insertKey"><span class="hs-identifier hs-var">insertKey</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;segments&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Segment) -&gt; SerializedItemDescriptor)
-&gt; HashMap Text (ItemDescriptor (Maybe Segment))
-&gt; KeyMap SerializedItemDescriptor
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Segment) -&gt; SerializedItemDescriptor
forall a.
ToJSON a =&gt;
ItemDescriptor (Maybe a) -&gt; SerializedItemDescriptor
</span><a href="LaunchDarkly.Server.Store.Internal.html#createSerializedItemDescriptor"><span class="hs-identifier hs-var">createSerializedItemDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">(HashMap Text (ItemDescriptor (Maybe Segment))
 -&gt; KeyMap SerializedItemDescriptor)
-&gt; HashMap Text (ItemDescriptor (Maybe Segment))
-&gt; KeyMap SerializedItemDescriptor
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyMap (ItemDescriptor Segment)
-&gt; HashMap Text (ItemDescriptor (Maybe Segment))
forall s v2 a.
HasField &quot;value&quot; s v2 a (Maybe a) =&gt;
HashMap Text s -&gt; HashMap Text v2
</span><a href="#local-6989586621679667493"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap (ItemDescriptor Segment)
</span><a href="#local-6989586621679667496"><span class="hs-identifier hs-var">segments</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621679667493"><span class="annot"><span class="annottext">c :: HashMap Text s -&gt; HashMap Text v2
</span><a href="#local-6989586621679667493"><span class="hs-identifier hs-var hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679667488"><span class="annot"><span class="annottext">x :: HashMap Text s
</span><a href="#local-6989586621679667488"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(s -&gt; v2) -&gt; HashMap Text s -&gt; HashMap Text v2
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679667487"><span class="annot"><span class="annottext">f :: s
</span><a href="#local-6989586621679667487"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679667487"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; (s -&gt; v2) -&gt; v2
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;value&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">((a -&gt; Identity (Maybe a)) -&gt; s -&gt; Identity v2)
-&gt; (a -&gt; Maybe a) -&gt; s -&gt; v2
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Text s
</span><a href="#local-6989586621679667488"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span id="local-6989586621679667747"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#serializedToItemDescriptor"><span class="hs-identifier hs-type">serializedToItemDescriptor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679667747"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasField'</span></span><span> </span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679667747"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679667747"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-284"></span><span id="serializedToItemDescriptor"><span class="annot"><span class="annottext">serializedToItemDescriptor :: SerializedItemDescriptor -&gt; Either Text (ItemDescriptor (Maybe a))
</span><a href="LaunchDarkly.Server.Store.Internal.html#serializedToItemDescriptor"><span class="hs-identifier hs-var hs-var">serializedToItemDescriptor</span></a></span></span><span> </span><span id="local-6989586621679667485"><span class="annot"><span class="annottext">serializedItem :: SerializedItemDescriptor
</span><a href="#local-6989586621679667485"><span class="hs-identifier hs-var">serializedItem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SerializedItemDescriptor -&gt; Maybe ByteString
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;item&quot;</span></span><span> </span><span class="annot"><span class="annottext">SerializedItemDescriptor
</span><a href="#local-6989586621679667485"><span class="hs-identifier hs-var">serializedItem</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-285"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; Either Text (ItemDescriptor (Maybe a))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe a)
 -&gt; Either Text (ItemDescriptor (Maybe a)))
-&gt; ItemDescriptor (Maybe a)
-&gt; Either Text (ItemDescriptor (Maybe a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Natural -&gt; ItemDescriptor (Maybe a)
forall a. a -&gt; Natural -&gt; ItemDescriptor a
</span><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SerializedItemDescriptor -&gt; Natural
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><span class="annottext">SerializedItemDescriptor
</span><a href="#local-6989586621679667485"><span class="hs-identifier hs-var">serializedItem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667484"><span class="annot"><span class="annottext">buffer :: ByteString
</span><a href="#local-6989586621679667484"><span class="hs-identifier hs-var">buffer</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-287"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679667483"><span class="annot"><span class="annottext">versionedData :: Maybe VersionedData
</span><a href="#local-6989586621679667483"><span class="hs-identifier hs-var hs-var">versionedData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe VersionedData
</span><a href="LaunchDarkly.Server.Store.Internal.html#byteStringToVersionedData"><span class="hs-identifier hs-var">byteStringToVersionedData</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679667484"><span class="hs-identifier hs-var">buffer</span></a></span><span>
</span><span id="line-288"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe VersionedData
</span><a href="#local-6989586621679667483"><span class="hs-identifier hs-var">versionedData</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text (ItemDescriptor (Maybe a))
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;failed decoding into VersionedData&quot;</span></span><span>
</span><span id="line-290"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#VersionedData"><span class="hs-identifier hs-type">VersionedData</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:deleted:VersionedData :: VersionedData -&gt; Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Adeleted%3AVersionedData"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:version:VersionedData :: VersionedData -&gt; Natural
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aversion%3AVersionedData"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679667482"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679667482"><span class="hs-identifier hs-var">version</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; Either Text (ItemDescriptor (Maybe a))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe a)
 -&gt; Either Text (ItemDescriptor (Maybe a)))
-&gt; ItemDescriptor (Maybe a)
-&gt; Either Text (ItemDescriptor (Maybe a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Natural -&gt; ItemDescriptor (Maybe a)
forall a. a -&gt; Natural -&gt; ItemDescriptor a
</span><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679667482"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-291"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679667481"><span class="annot"><span class="annottext">decodeResult :: Maybe a
</span><a href="#local-6989586621679667481"><span class="hs-identifier hs-var hs-var">decodeResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe a
forall a. FromJSON a =&gt; ByteString -&gt; Maybe a
</span><span class="hs-identifier hs-var">decode</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Maybe a) -&gt; ByteString -&gt; Maybe a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">fromStrict</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679667484"><span class="hs-identifier hs-var">buffer</span></a></span><span>
</span><span id="line-293"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679667481"><span class="hs-identifier hs-var">decodeResult</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-294"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text (ItemDescriptor (Maybe a))
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;failed decoding into ItemDescriptor&quot;</span></span><span>
</span><span id="line-295"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667480"><span class="annot"><span class="annottext">decoded :: a
</span><a href="#local-6989586621679667480"><span class="hs-identifier hs-var">decoded</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; Either Text (ItemDescriptor (Maybe a))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe a)
 -&gt; Either Text (ItemDescriptor (Maybe a)))
-&gt; ItemDescriptor (Maybe a)
-&gt; Either Text (ItemDescriptor (Maybe a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Natural -&gt; ItemDescriptor (Maybe a)
forall a. a -&gt; Natural -&gt; ItemDescriptor a
</span><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-var">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679667480"><span class="hs-identifier hs-var">decoded</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Natural
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679667480"><span class="hs-identifier hs-var">decoded</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span id="local-6989586621679667751"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#createSerializedItemDescriptor"><span class="hs-identifier hs-type">createSerializedItemDescriptor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679667751"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679667751"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span></span><span>
</span><span id="line-298"></span><span id="createSerializedItemDescriptor"><span class="annot"><span class="annottext">createSerializedItemDescriptor :: ItemDescriptor (Maybe a) -&gt; SerializedItemDescriptor
</span><a href="LaunchDarkly.Server.Store.Internal.html#createSerializedItemDescriptor"><span class="hs-identifier hs-var hs-var">createSerializedItemDescriptor</span></a></span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:value:ItemDescriptor :: forall a. ItemDescriptor a -&gt; a
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Avalue%3AItemDescriptor"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679667479"><span class="annot"><span class="annottext">Natural
version :: Natural
$sel:version:ItemDescriptor :: forall a. ItemDescriptor a -&gt; Natural
</span><a href="#local-6989586621679667479"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">$WSerializedItemDescriptor :: Maybe ByteString -&gt; Natural -&gt; Bool -&gt; SerializedItemDescriptor
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24WSerializedItemDescriptor"><span class="hs-identifier hs-type hs-type">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:item:SerializedItemDescriptor :: Maybe ByteString
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aitem%3ASerializedItemDescriptor"><span class="hs-identifier hs-var">item</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
version :: Natural
$sel:version:SerializedItemDescriptor :: Natural
</span><a href="#local-6989586621679667479"><span class="hs-identifier hs-var hs-var">version</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:deleted:SerializedItemDescriptor :: Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Adeleted%3ASerializedItemDescriptor"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">}</span><span>
</span><span id="line-299"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#createSerializedItemDescriptor"><span class="hs-identifier hs-var">createSerializedItemDescriptor</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:value:ItemDescriptor :: forall a. ItemDescriptor a -&gt; a
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Avalue%3AItemDescriptor"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667477"><span class="annot"><span class="annottext">item :: a
</span><a href="#local-6989586621679667477"><span class="hs-identifier hs-var">item</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679667476"><span class="annot"><span class="annottext">Natural
version :: Natural
$sel:version:ItemDescriptor :: forall a. ItemDescriptor a -&gt; Natural
</span><a href="#local-6989586621679667476"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">$WSerializedItemDescriptor :: Maybe ByteString -&gt; Natural -&gt; Bool -&gt; SerializedItemDescriptor
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24WSerializedItemDescriptor"><span class="hs-identifier hs-type hs-type">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:item:SerializedItemDescriptor :: Maybe ByteString
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Aitem%3ASerializedItemDescriptor"><span class="hs-identifier hs-var">item</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Maybe ByteString) -&gt; ByteString -&gt; Maybe ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">toStrict</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString) -&gt; ByteString -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">encode</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679667477"><span class="hs-identifier hs-var">item</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
version :: Natural
$sel:version:SerializedItemDescriptor :: Natural
</span><a href="#local-6989586621679667476"><span class="hs-identifier hs-var hs-var">version</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:deleted:SerializedItemDescriptor :: Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3Adeleted%3ASerializedItemDescriptor"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">}</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span id="local-6989586621679667735"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#tryGetBackend"><span class="hs-identifier hs-type">tryGetBackend</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679667735"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasField'</span></span><span> </span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679667735"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#PersistentDataStore"><span class="hs-identifier hs-type">PersistentDataStore</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679667735"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-302"></span><span id="tryGetBackend"><span class="annot"><span class="annottext">tryGetBackend :: PersistentDataStore
-&gt; Text -&gt; Text -&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
</span><a href="LaunchDarkly.Server.Store.Internal.html#tryGetBackend"><span class="hs-identifier hs-var hs-var">tryGetBackend</span></a></span></span><span> </span><span id="local-6989586621679667474"><span class="annot"><span class="annottext">backend :: PersistentDataStore
</span><a href="#local-6989586621679667474"><span class="hs-identifier hs-var">backend</span></a></span></span><span> </span><span id="local-6989586621679667473"><span class="annot"><span class="annottext">namespace :: Text
</span><a href="#local-6989586621679667473"><span class="hs-identifier hs-var">namespace</span></a></span></span><span> </span><span id="local-6989586621679667472"><span class="annot"><span class="annottext">key :: Text
</span><a href="#local-6989586621679667472"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">PersistentDataStore
-&gt; Text -&gt; Text -&gt; StoreResult (Maybe SerializedItemDescriptor)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreGetFeature%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreGetFeature</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentDataStore
</span><a href="#local-6989586621679667474"><span class="hs-identifier hs-var">backend</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667473"><span class="hs-identifier hs-var">namespace</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667472"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StoreResult (Maybe SerializedItemDescriptor)
-&gt; (Either Text (Maybe SerializedItemDescriptor)
    -&gt; StoreResult (Maybe (ItemDescriptor (Maybe a))))
-&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-304"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679667471"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679667471"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe (ItemDescriptor (Maybe a)))
-&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe (ItemDescriptor (Maybe a)))
 -&gt; StoreResult (Maybe (ItemDescriptor (Maybe a))))
-&gt; Either Text (Maybe (ItemDescriptor (Maybe a)))
-&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text (Maybe (ItemDescriptor (Maybe a)))
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667471"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-305"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe (ItemDescriptor (Maybe a)))
-&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe (ItemDescriptor (Maybe a)))
 -&gt; StoreResult (Maybe (ItemDescriptor (Maybe a))))
-&gt; Either Text (Maybe (ItemDescriptor (Maybe a)))
-&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ItemDescriptor (Maybe a))
-&gt; Either Text (Maybe (ItemDescriptor (Maybe a)))
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ItemDescriptor (Maybe a))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-306"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667470"><span class="annot"><span class="annottext">serializedItem :: SerializedItemDescriptor
</span><a href="#local-6989586621679667470"><span class="hs-identifier hs-var">serializedItem</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SerializedItemDescriptor -&gt; Either Text (ItemDescriptor (Maybe a))
forall a.
(FromJSON a, HasField' &quot;version&quot; a Natural) =&gt;
SerializedItemDescriptor -&gt; Either Text (ItemDescriptor (Maybe a))
</span><a href="LaunchDarkly.Server.Store.Internal.html#serializedToItemDescriptor"><span class="hs-identifier hs-var">serializedToItemDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">SerializedItemDescriptor
</span><a href="#local-6989586621679667470"><span class="hs-identifier hs-var">serializedItem</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-307"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679667469"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679667469"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe (ItemDescriptor (Maybe a)))
-&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe (ItemDescriptor (Maybe a)))
 -&gt; StoreResult (Maybe (ItemDescriptor (Maybe a))))
-&gt; Either Text (Maybe (ItemDescriptor (Maybe a)))
-&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text (Maybe (ItemDescriptor (Maybe a)))
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667469"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-308"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679667468"><span class="annot"><span class="annottext">versioned :: ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667468"><span class="hs-identifier hs-var">versioned</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe (ItemDescriptor (Maybe a)))
-&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe (ItemDescriptor (Maybe a)))
 -&gt; StoreResult (Maybe (ItemDescriptor (Maybe a))))
-&gt; Either Text (Maybe (ItemDescriptor (Maybe a)))
-&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ItemDescriptor (Maybe a))
-&gt; Either Text (Maybe (ItemDescriptor (Maybe a)))
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (ItemDescriptor (Maybe a))
 -&gt; Either Text (Maybe (ItemDescriptor (Maybe a))))
-&gt; Maybe (ItemDescriptor (Maybe a))
-&gt; Either Text (Maybe (ItemDescriptor (Maybe a)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; Maybe (ItemDescriptor (Maybe a))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667468"><span class="hs-identifier hs-var">versioned</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span id="local-6989586621679667734"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getGeneric"><span class="hs-identifier hs-type">getGeneric</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679667734"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasField'</span></span><span> </span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><a href="#local-6989586621679667734"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Natural</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-313"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Lens'</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-type">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#CacheableItem"><span class="hs-identifier hs-type">CacheableItem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667734"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679667734"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-317"></span><span id="getGeneric"><span class="annot"><span class="annottext">getGeneric :: Store
-&gt; Text
-&gt; Text
-&gt; Lens' State (KeyMap (Expirable (CacheableItem a)))
-&gt; StoreResult (Maybe a)
</span><a href="LaunchDarkly.Server.Store.Internal.html#getGeneric"><span class="hs-identifier hs-var hs-var">getGeneric</span></a></span></span><span> </span><span id="local-6989586621679667466"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667466"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667465"><span class="annot"><span class="annottext">namespace :: Text
</span><a href="#local-6989586621679667465"><span class="hs-identifier hs-var">namespace</span></a></span></span><span> </span><span id="local-6989586621679667464"><span class="annot"><span class="annottext">key :: Text
</span><a href="#local-6989586621679667464"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621679667463"><span class="annot"><span class="annottext">lens :: Lens' State (KeyMap (Expirable (CacheableItem a)))
</span><a href="#local-6989586621679667463"><span class="hs-identifier hs-var">lens</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>    </span><span id="local-6989586621679667462"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667462"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; IO State
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef State -&gt; IO State) -&gt; IORef State -&gt; IO State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667466"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Store -&gt; Maybe PersistentDataStore
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;backend&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667466"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-320"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; KeyMap (Expirable (CacheableItem a))
-&gt; Maybe (Expirable (CacheableItem a))
forall v. Text -&gt; HashMap Text v -&gt; Maybe v
</span><a href="LaunchDarkly.AesonCompat.html#lookupKey"><span class="hs-identifier hs-var">lookupKey</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667464"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667462"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">State
-&gt; Getting
     (KeyMap (Expirable (CacheableItem a)))
     State
     (KeyMap (Expirable (CacheableItem a)))
-&gt; KeyMap (Expirable (CacheableItem a))
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (KeyMap (Expirable (CacheableItem a)))
  State
  (KeyMap (Expirable (CacheableItem a)))
Lens' State (KeyMap (Expirable (CacheableItem a)))
</span><a href="#local-6989586621679667463"><span class="hs-identifier hs-var">lens</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-321"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe a) -&gt; StoreResult (Maybe a))
-&gt; Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Either Text (Maybe a)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-322"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667461"><span class="annot"><span class="annottext">cacheItem :: Expirable (CacheableItem a)
</span><a href="#local-6989586621679667461"><span class="hs-identifier hs-var">cacheItem</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe a) -&gt; StoreResult (Maybe a))
-&gt; Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Either Text (Maybe a)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; Either Text (Maybe a))
-&gt; Maybe a -&gt; Either Text (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a s. HasField' &quot;value&quot; s a =&gt; s -&gt; a
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe a) -&gt; Maybe a) -&gt; CacheableItem a -&gt; Maybe a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expirable (CacheableItem a) -&gt; CacheableItem a
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">Expirable (CacheableItem a)
</span><a href="#local-6989586621679667461"><span class="hs-identifier hs-var">cacheItem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667459"><span class="annot"><span class="annottext">backend :: PersistentDataStore
</span><a href="#local-6989586621679667459"><span class="hs-identifier hs-var">backend</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-324"></span><span>            </span><span id="local-6989586621679667458"><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667458"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TimeSpec
</span><a href="LaunchDarkly.Server.Store.Internal.html#getMonotonicTime"><span class="hs-identifier hs-var">getMonotonicTime</span></a></span><span>
</span><span id="line-325"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; KeyMap (Expirable (CacheableItem a))
-&gt; Maybe (Expirable (CacheableItem a))
forall v. Text -&gt; HashMap Text v -&gt; Maybe v
</span><a href="LaunchDarkly.AesonCompat.html#lookupKey"><span class="hs-identifier hs-var">lookupKey</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667464"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667462"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">State
-&gt; Getting
     (KeyMap (Expirable (CacheableItem a)))
     State
     (KeyMap (Expirable (CacheableItem a)))
-&gt; KeyMap (Expirable (CacheableItem a))
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (KeyMap (Expirable (CacheableItem a)))
  State
  (KeyMap (Expirable (CacheableItem a)))
Lens' State (KeyMap (Expirable (CacheableItem a)))
</span><a href="#local-6989586621679667463"><span class="hs-identifier hs-var">lens</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-326"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PersistentDataStore -&gt; TimeSpec -&gt; StoreResult (Maybe a)
</span><a href="#local-6989586621679667457"><span class="hs-identifier hs-var">updateFromBackend</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentDataStore
</span><a href="#local-6989586621679667459"><span class="hs-identifier hs-var">backend</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667458"><span class="hs-identifier hs-var">now</span></a></span><span>
</span><span id="line-327"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667456"><span class="annot"><span class="annottext">cacheItem :: Expirable (CacheableItem a)
</span><a href="#local-6989586621679667456"><span class="hs-identifier hs-var">cacheItem</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-328"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Store -&gt; TimeSpec -&gt; Expirable (CacheableItem a) -&gt; Bool
forall a. Store -&gt; TimeSpec -&gt; Expirable a -&gt; Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#isExpired"><span class="hs-identifier hs-var">isExpired</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667466"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667458"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">Expirable (CacheableItem a)
</span><a href="#local-6989586621679667456"><span class="hs-identifier hs-var">cacheItem</span></a></span><span>
</span><span id="line-329"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">PersistentDataStore -&gt; TimeSpec -&gt; StoreResult (Maybe a)
</span><a href="#local-6989586621679667457"><span class="hs-identifier hs-var">updateFromBackend</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentDataStore
</span><a href="#local-6989586621679667459"><span class="hs-identifier hs-var">backend</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667458"><span class="hs-identifier hs-var">now</span></a></span><span>
</span><span id="line-330"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe a) -&gt; StoreResult (Maybe a))
-&gt; Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Either Text (Maybe a)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; Either Text (Maybe a))
-&gt; Maybe a -&gt; Either Text (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a s. HasField' &quot;value&quot; s a =&gt; s -&gt; a
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe a) -&gt; Maybe a) -&gt; CacheableItem a -&gt; Maybe a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Expirable (CacheableItem a) -&gt; CacheableItem a
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">Expirable (CacheableItem a)
</span><a href="#local-6989586621679667456"><span class="hs-identifier hs-var">cacheItem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-332"></span><span>    </span><span id="local-6989586621679667457"><span class="annot"><span class="annottext">updateFromBackend :: PersistentDataStore -&gt; TimeSpec -&gt; StoreResult (Maybe a)
</span><a href="#local-6989586621679667457"><span class="hs-identifier hs-var hs-var">updateFromBackend</span></a></span></span><span> </span><span id="local-6989586621679667455"><span class="annot"><span class="annottext">backend :: PersistentDataStore
</span><a href="#local-6989586621679667455"><span class="hs-identifier hs-var">backend</span></a></span></span><span> </span><span id="local-6989586621679667454"><span class="annot"><span class="annottext">now :: TimeSpec
</span><a href="#local-6989586621679667454"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-333"></span><span>        </span><span class="annot"><span class="annottext">PersistentDataStore
-&gt; Text -&gt; Text -&gt; StoreResult (CacheableItem a)
forall a.
(FromJSON a, HasField' &quot;version&quot; a Natural) =&gt;
PersistentDataStore
-&gt; Text -&gt; Text -&gt; StoreResult (Maybe (ItemDescriptor (Maybe a)))
</span><a href="LaunchDarkly.Server.Store.Internal.html#tryGetBackend"><span class="hs-identifier hs-var">tryGetBackend</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentDataStore
</span><a href="#local-6989586621679667455"><span class="hs-identifier hs-var">backend</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667465"><span class="hs-identifier hs-var">namespace</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667464"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">StoreResult (CacheableItem a)
-&gt; (Either Text (CacheableItem a) -&gt; StoreResult (Maybe a))
-&gt; StoreResult (Maybe a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-334"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679667453"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679667453"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe a) -&gt; StoreResult (Maybe a))
-&gt; Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text (Maybe a)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667453"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-335"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-336"></span><span>                </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667466"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, ())) -&gt; IO ())
-&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679667452"><span class="annot"><span class="annottext">stateRef :: State
</span><a href="#local-6989586621679667452"><span class="hs-identifier hs-var">stateRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-337"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; (State, ())) -&gt; State -&gt; (State, ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-338"></span><span>                        </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667452"><span class="hs-identifier hs-var">stateRef</span></a></span><span>
</span><span id="line-339"></span><span>                            </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(KeyMap (Expirable (CacheableItem a))
 -&gt; Identity (KeyMap (Expirable (CacheableItem a))))
-&gt; State -&gt; Identity State
Lens' State (KeyMap (Expirable (CacheableItem a)))
</span><a href="#local-6989586621679667463"><span class="hs-identifier hs-var">lens</span></a></span><span>
</span><span id="line-340"></span><span>                                </span><span class="annot"><span class="annottext">((KeyMap (Expirable (CacheableItem a))
  -&gt; Identity (KeyMap (Expirable (CacheableItem a))))
 -&gt; State -&gt; Identity State)
-&gt; (KeyMap (Expirable (CacheableItem a))
    -&gt; KeyMap (Expirable (CacheableItem a)))
-&gt; State
-&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
-&gt; Expirable (CacheableItem a)
-&gt; KeyMap (Expirable (CacheableItem a))
-&gt; KeyMap (Expirable (CacheableItem a))
forall v. Text -&gt; v -&gt; HashMap Text v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#insertKey"><span class="hs-identifier hs-var">insertKey</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667464"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CacheableItem a -&gt; Bool -&gt; TimeSpec -&gt; Expirable (CacheableItem a)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="annot"><span class="annottext">CacheableItem a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667454"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>                </span><span class="annot"><span class="annottext">Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe a) -&gt; StoreResult (Maybe a))
-&gt; Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Either Text (Maybe a)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-342"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667451"><span class="annot"><span class="annottext">v :: ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667451"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>                </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667466"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, ())) -&gt; IO ())
-&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679667450"><span class="annot"><span class="annottext">stateRef :: State
</span><a href="#local-6989586621679667450"><span class="hs-identifier hs-var">stateRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-344"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; (State, ())) -&gt; State -&gt; (State, ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-345"></span><span>                        </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667450"><span class="hs-identifier hs-var">stateRef</span></a></span><span>
</span><span id="line-346"></span><span>                            </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(KeyMap (Expirable (CacheableItem a))
 -&gt; Identity (KeyMap (Expirable (CacheableItem a))))
-&gt; State -&gt; Identity State
Lens' State (KeyMap (Expirable (CacheableItem a)))
</span><a href="#local-6989586621679667463"><span class="hs-identifier hs-var">lens</span></a></span><span>
</span><span id="line-347"></span><span>                                </span><span class="annot"><span class="annottext">((KeyMap (Expirable (CacheableItem a))
  -&gt; Identity (KeyMap (Expirable (CacheableItem a))))
 -&gt; State -&gt; Identity State)
-&gt; (KeyMap (Expirable (CacheableItem a))
    -&gt; KeyMap (Expirable (CacheableItem a)))
-&gt; State
-&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
-&gt; Expirable (CacheableItem a)
-&gt; KeyMap (Expirable (CacheableItem a))
-&gt; KeyMap (Expirable (CacheableItem a))
forall v. Text -&gt; v -&gt; HashMap Text v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#insertKey"><span class="hs-identifier hs-var">insertKey</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667464"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CacheableItem a -&gt; Bool -&gt; TimeSpec -&gt; Expirable (CacheableItem a)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; CacheableItem a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667451"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667454"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>                </span><span class="annot"><span class="annottext">Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (Maybe a) -&gt; StoreResult (Maybe a))
-&gt; Either Text (Maybe a) -&gt; StoreResult (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Either Text (Maybe a)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; Either Text (Maybe a))
-&gt; Maybe a -&gt; Either Text (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; Maybe a
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667451"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getFlag"><span class="hs-identifier hs-type">getFlag</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span id="getFlag"><span class="annot"><span class="annottext">getFlag :: Store -&gt; Text -&gt; StoreResultM IO (Maybe Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#getFlag"><span class="hs-identifier hs-var hs-var">getFlag</span></a></span></span><span> </span><span id="local-6989586621679667449"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667449"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667448"><span class="annot"><span class="annottext">key :: Text
</span><a href="#local-6989586621679667448"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store
-&gt; Text
-&gt; Text
-&gt; Lens' State (KeyMap (Expirable (CacheableItem Flag)))
-&gt; StoreResultM IO (Maybe Flag)
forall a.
(FromJSON a, HasField' &quot;version&quot; a Natural) =&gt;
Store
-&gt; Text
-&gt; Text
-&gt; Lens' State (KeyMap (Expirable (CacheableItem a)))
-&gt; StoreResult (Maybe a)
</span><a href="LaunchDarkly.Server.Store.Internal.html#getGeneric"><span class="hs-identifier hs-var">getGeneric</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667449"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;features&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667448"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;features&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;features&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getSegment"><span class="hs-identifier hs-type">getSegment</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span id="getSegment"><span class="annot"><span class="annottext">getSegment :: Store -&gt; Text -&gt; StoreResultM IO (Maybe Segment)
</span><a href="LaunchDarkly.Server.Store.Internal.html#getSegment"><span class="hs-identifier hs-var hs-var">getSegment</span></a></span></span><span> </span><span id="local-6989586621679667447"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667447"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667446"><span class="annot"><span class="annottext">key :: Text
</span><a href="#local-6989586621679667446"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store
-&gt; Text
-&gt; Text
-&gt; Lens' State (KeyMap (Expirable (CacheableItem Segment)))
-&gt; StoreResultM IO (Maybe Segment)
forall a.
(FromJSON a, HasField' &quot;version&quot; a Natural) =&gt;
Store
-&gt; Text
-&gt; Text
-&gt; Lens' State (KeyMap (Expirable (CacheableItem a)))
-&gt; StoreResult (Maybe a)
</span><a href="LaunchDarkly.Server.Store.Internal.html#getGeneric"><span class="hs-identifier hs-var">getGeneric</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667447"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;segments&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667446"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;segments&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;segments&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span id="local-6989586621679667728"><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#upsertGeneric"><span class="hs-identifier hs-type">upsertGeneric</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621679667728"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-358"></span><span>    </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-359"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-360"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-361"></span><span>    </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679667728"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Lens'</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-type">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#CacheableItem"><span class="hs-identifier hs-type">CacheableItem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679667728"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#State"><span class="hs-identifier hs-type">State</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-364"></span><span>    </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-365"></span><span id="upsertGeneric"><span class="annot"><span class="annottext">upsertGeneric :: Store
-&gt; Text
-&gt; Text
-&gt; ItemDescriptor (Maybe a)
-&gt; Lens' State (KeyMap (Expirable (CacheableItem a)))
-&gt; (Bool -&gt; State -&gt; State)
-&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertGeneric"><span class="hs-identifier hs-var hs-var">upsertGeneric</span></a></span></span><span> </span><span id="local-6989586621679667444"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667444"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667443"><span class="annot"><span class="annottext">namespace :: Text
</span><a href="#local-6989586621679667443"><span class="hs-identifier hs-var">namespace</span></a></span></span><span> </span><span id="local-6989586621679667442"><span class="annot"><span class="annottext">key :: Text
</span><a href="#local-6989586621679667442"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621679667441"><span class="annot"><span class="annottext">versioned :: ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667441"><span class="hs-identifier hs-var">versioned</span></a></span></span><span> </span><span id="local-6989586621679667440"><span class="annot"><span class="annottext">lens :: Lens' State (KeyMap (Expirable (CacheableItem a)))
</span><a href="#local-6989586621679667440"><span class="hs-identifier hs-var">lens</span></a></span></span><span> </span><span id="local-6989586621679667439"><span class="annot"><span class="annottext">action :: Bool -&gt; State -&gt; State
</span><a href="#local-6989586621679667439"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Store -&gt; Maybe PersistentDataStore
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;backend&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667444"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-368"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667444"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, ())) -&gt; IO ())
-&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679667438"><span class="annot"><span class="annottext">stateRef :: State
</span><a href="#local-6989586621679667438"><span class="hs-identifier hs-var">stateRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; (State, ())) -&gt; State -&gt; (State, ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State -&gt; State
</span><a href="#local-6989586621679667437"><span class="hs-identifier hs-var">upsertMemory</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667438"><span class="hs-identifier hs-var">stateRef</span></a></span><span>
</span><span id="line-369"></span><span>            </span><span class="annot"><span class="annottext">Either Text () -&gt; StoreResultM IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text () -&gt; StoreResultM IO ())
-&gt; Either Text () -&gt; StoreResultM IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either Text ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667436"><span class="annot"><span class="annottext">backend :: PersistentDataStore
</span><a href="#local-6989586621679667436"><span class="hs-identifier hs-var">backend</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-371"></span><span>            </span><span id="local-6989586621679667435"><span class="annot"><span class="annottext">Either Text Bool
</span><a href="#local-6989586621679667435"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PersistentDataStore
-&gt; Text -&gt; Text -&gt; SerializedItemDescriptor -&gt; StoreResultM IO Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreUpsertFeature%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreUpsertFeature</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentDataStore
</span><a href="#local-6989586621679667436"><span class="hs-identifier hs-var">backend</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667443"><span class="hs-identifier hs-var">namespace</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667442"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; SerializedItemDescriptor
forall a.
ToJSON a =&gt;
ItemDescriptor (Maybe a) -&gt; SerializedItemDescriptor
</span><a href="LaunchDarkly.Server.Store.Internal.html#createSerializedItemDescriptor"><span class="hs-identifier hs-var">createSerializedItemDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667441"><span class="hs-identifier hs-var">versioned</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text Bool
</span><a href="#local-6989586621679667435"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-373"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679667434"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679667434"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text () -&gt; StoreResultM IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text () -&gt; StoreResultM IO ())
-&gt; Either Text () -&gt; StoreResultM IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667434"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-374"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679667433"><span class="annot"><span class="annottext">updated :: Bool
</span><a href="#local-6989586621679667433"><span class="hs-identifier hs-var">updated</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-375"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679667433"><span class="hs-identifier hs-var">updated</span></a></span><span>
</span><span id="line-376"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Either Text () -&gt; StoreResultM IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; Either Text ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>                            </span><span id="local-6989586621679667431"><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667431"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TimeSpec
</span><a href="LaunchDarkly.Server.Store.Internal.html#getMonotonicTime"><span class="hs-identifier hs-var">getMonotonicTime</span></a></span><span>
</span><span id="line-379"></span><span>                            </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667444"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, ())) -&gt; IO ())
-&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679667430"><span class="annot"><span class="annottext">stateRef :: State
</span><a href="#local-6989586621679667430"><span class="hs-identifier hs-var">stateRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-380"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; (State, ())) -&gt; State -&gt; (State, ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-381"></span><span>                                    </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667430"><span class="hs-identifier hs-var">stateRef</span></a></span><span>
</span><span id="line-382"></span><span>                                        </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(KeyMap (Expirable (CacheableItem a))
 -&gt; Identity (KeyMap (Expirable (CacheableItem a))))
-&gt; State -&gt; Identity State
Lens' State (KeyMap (Expirable (CacheableItem a)))
</span><a href="#local-6989586621679667440"><span class="hs-identifier hs-var">lens</span></a></span><span> </span><span class="annot"><span class="annottext">((KeyMap (Expirable (CacheableItem a))
  -&gt; Identity (KeyMap (Expirable (CacheableItem a))))
 -&gt; State -&gt; Identity State)
-&gt; (KeyMap (Expirable (CacheableItem a))
    -&gt; KeyMap (Expirable (CacheableItem a)))
-&gt; State
-&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
-&gt; Expirable (CacheableItem a)
-&gt; KeyMap (Expirable (CacheableItem a))
-&gt; KeyMap (Expirable (CacheableItem a))
forall v. Text -&gt; v -&gt; HashMap Text v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#insertKey"><span class="hs-identifier hs-var">insertKey</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667442"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CacheableItem a -&gt; Bool -&gt; TimeSpec -&gt; Expirable (CacheableItem a)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; CacheableItem a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667441"><span class="hs-identifier hs-var">versioned</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667431"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>                                        </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; State -&gt; State
</span><a href="#local-6989586621679667439"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-384"></span><span>                            </span><span class="annot"><span class="annottext">Either Text () -&gt; StoreResultM IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text () -&gt; StoreResultM IO ())
-&gt; Either Text () -&gt; StoreResultM IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; Either Text ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-386"></span><span>    </span><span id="local-6989586621679667437"><span class="annot"><span class="annottext">upsertMemory :: State -&gt; State
</span><a href="#local-6989586621679667437"><span class="hs-identifier hs-var hs-var">upsertMemory</span></a></span></span><span> </span><span id="local-6989586621679667429"><span class="annot"><span class="annottext">state :: State
</span><a href="#local-6989586621679667429"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; KeyMap (Expirable (CacheableItem a))
-&gt; Maybe (Expirable (CacheableItem a))
forall v. Text -&gt; HashMap Text v -&gt; Maybe v
</span><a href="LaunchDarkly.AesonCompat.html#lookupKey"><span class="hs-identifier hs-var">lookupKey</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667442"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667429"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">State
-&gt; Getting
     (KeyMap (Expirable (CacheableItem a)))
     State
     (KeyMap (Expirable (CacheableItem a)))
-&gt; KeyMap (Expirable (CacheableItem a))
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (KeyMap (Expirable (CacheableItem a)))
  State
  (KeyMap (Expirable (CacheableItem a)))
Lens' State (KeyMap (Expirable (CacheableItem a)))
</span><a href="#local-6989586621679667440"><span class="hs-identifier hs-var">lens</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-387"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State -&gt; State
</span><a href="#local-6989586621679667428"><span class="hs-identifier hs-var">updateMemory</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667429"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667427"><span class="annot"><span class="annottext">cacheItem :: Expirable (CacheableItem a)
</span><a href="#local-6989586621679667427"><span class="hs-identifier hs-var">cacheItem</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Expirable (CacheableItem a) -&gt; CacheableItem a
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">Expirable (CacheableItem a)
</span><a href="#local-6989586621679667427"><span class="hs-identifier hs-var">cacheItem</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-389"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">State -&gt; State
</span><a href="#local-6989586621679667428"><span class="hs-identifier hs-var">updateMemory</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667429"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-390"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667426"><span class="annot"><span class="annottext">existing :: ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667426"><span class="hs-identifier hs-var">existing</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-391"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; Natural
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667426"><span class="hs-identifier hs-var">existing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; Natural
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;version&quot;</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667441"><span class="hs-identifier hs-var">versioned</span></a></span><span>
</span><span id="line-392"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">State -&gt; State
</span><a href="#local-6989586621679667428"><span class="hs-identifier hs-var">updateMemory</span></a></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667429"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-393"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667429"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621679667428"><span class="annot"><span class="annottext">updateMemory :: State -&gt; State
</span><a href="#local-6989586621679667428"><span class="hs-identifier hs-var hs-var">updateMemory</span></a></span></span><span> </span><span id="local-6989586621679667425"><span class="annot"><span class="annottext">state :: State
</span><a href="#local-6989586621679667425"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-395"></span><span>        </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667425"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-396"></span><span>            </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(KeyMap (Expirable (CacheableItem a))
 -&gt; Identity (KeyMap (Expirable (CacheableItem a))))
-&gt; State -&gt; Identity State
Lens' State (KeyMap (Expirable (CacheableItem a)))
</span><a href="#local-6989586621679667440"><span class="hs-identifier hs-var">lens</span></a></span><span> </span><span class="annot"><span class="annottext">((KeyMap (Expirable (CacheableItem a))
  -&gt; Identity (KeyMap (Expirable (CacheableItem a))))
 -&gt; State -&gt; Identity State)
-&gt; (KeyMap (Expirable (CacheableItem a))
    -&gt; KeyMap (Expirable (CacheableItem a)))
-&gt; State
-&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
-&gt; Expirable (CacheableItem a)
-&gt; KeyMap (Expirable (CacheableItem a))
-&gt; KeyMap (Expirable (CacheableItem a))
forall v. Text -&gt; v -&gt; HashMap Text v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#insertKey"><span class="hs-identifier hs-var">insertKey</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667442"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CacheableItem a -&gt; Bool -&gt; TimeSpec -&gt; Expirable (CacheableItem a)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a) -&gt; CacheableItem a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe a)
</span><a href="#local-6989586621679667441"><span class="hs-identifier hs-var">versioned</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>            </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; State -&gt; State
</span><a href="#local-6989586621679667439"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#upsertFlag"><span class="hs-identifier hs-type">upsertFlag</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span id="upsertFlag"><span class="annot"><span class="annottext">upsertFlag :: Store -&gt; Text -&gt; ItemDescriptor (Maybe Flag) -&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertFlag"><span class="hs-identifier hs-var hs-var">upsertFlag</span></a></span></span><span> </span><span id="local-6989586621679667424"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667424"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667423"><span class="annot"><span class="annottext">key :: Text
</span><a href="#local-6989586621679667423"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621679667422"><span class="annot"><span class="annottext">versioned :: ItemDescriptor (Maybe Flag)
</span><a href="#local-6989586621679667422"><span class="hs-identifier hs-var">versioned</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store
-&gt; Text
-&gt; Text
-&gt; ItemDescriptor (Maybe Flag)
-&gt; Lens' State (KeyMap (Expirable (CacheableItem Flag)))
-&gt; (Bool -&gt; State -&gt; State)
-&gt; StoreResultM IO ()
forall a.
ToJSON a =&gt;
Store
-&gt; Text
-&gt; Text
-&gt; ItemDescriptor (Maybe a)
-&gt; Lens' State (KeyMap (Expirable (CacheableItem a)))
-&gt; (Bool -&gt; State -&gt; State)
-&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertGeneric"><span class="hs-identifier hs-var">upsertGeneric</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667424"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;features&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667423"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Flag)
</span><a href="#local-6989586621679667422"><span class="hs-identifier hs-var">versioned</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;features&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;features&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; State -&gt; State
</span><a href="#local-6989586621679667421"><span class="hs-identifier hs-var">postAction</span></a></span><span>
</span><span id="line-401"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-402"></span><span>    </span><span id="local-6989586621679667421"><span class="annot"><span class="annottext">postAction :: Bool -&gt; State -&gt; State
</span><a href="#local-6989586621679667421"><span class="hs-identifier hs-var hs-var">postAction</span></a></span></span><span> </span><span id="local-6989586621679667420"><span class="annot"><span class="annottext">external :: Bool
</span><a href="#local-6989586621679667420"><span class="hs-identifier hs-var">external</span></a></span></span><span> </span><span id="local-6989586621679667419"><span class="annot"><span class="annottext">state :: State
</span><a href="#local-6989586621679667419"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-403"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679667420"><span class="hs-identifier hs-var">external</span></a></span><span>
</span><span id="line-404"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667419"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;allFlags&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;allFlags&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Expirable (KeyMap Flag) -&gt; Identity (Expirable (KeyMap Flag)))
 -&gt; State -&gt; Identity State)
-&gt; (Expirable (KeyMap Flag) -&gt; Expirable (KeyMap Flag))
-&gt; State
-&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Expirable (KeyMap Flag) -&gt; Expirable (KeyMap Flag)
forall (f :: Symbol) s a. HasField' f s a =&gt; a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">setField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;forceExpire&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667419"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">State -&gt; (State -&gt; State) -&gt; State
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;allFlags&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;allFlags&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Expirable (KeyMap Flag) -&gt; Identity (Expirable (KeyMap Flag)))
 -&gt; State -&gt; Identity State)
-&gt; ((KeyMap Flag -&gt; Identity (KeyMap Flag))
    -&gt; Expirable (KeyMap Flag) -&gt; Identity (Expirable (KeyMap Flag)))
-&gt; (KeyMap Flag -&gt; Identity (KeyMap Flag))
-&gt; State
-&gt; Identity State
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;value&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((KeyMap Flag -&gt; Identity (KeyMap Flag))
 -&gt; State -&gt; Identity State)
-&gt; (KeyMap Flag -&gt; KeyMap Flag) -&gt; State -&gt; State
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">KeyMap Flag -&gt; KeyMap Flag
</span><a href="#local-6989586621679667417"><span class="hs-identifier hs-var">updateAllFlags</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span id="local-6989586621679667417"><span class="annot"><span class="annottext">updateAllFlags :: KeyMap Flag -&gt; KeyMap Flag
</span><a href="#local-6989586621679667417"><span class="hs-identifier hs-var hs-var">updateAllFlags</span></a></span></span><span> </span><span id="local-6989586621679667416"><span class="annot"><span class="annottext">allFlags :: KeyMap Flag
</span><a href="#local-6989586621679667416"><span class="hs-identifier hs-var">allFlags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Flag) -&gt; Maybe Flag
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Flag)
</span><a href="#local-6989586621679667422"><span class="hs-identifier hs-var">versioned</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-407"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; KeyMap Flag -&gt; KeyMap Flag
forall v. Text -&gt; HashMap Text v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#deleteKey"><span class="hs-identifier hs-var">deleteKey</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667423"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap Flag
</span><a href="#local-6989586621679667416"><span class="hs-identifier hs-var">allFlags</span></a></span><span>
</span><span id="line-408"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667415"><span class="annot"><span class="annottext">flag :: Flag
</span><a href="#local-6989586621679667415"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Flag -&gt; KeyMap Flag -&gt; KeyMap Flag
forall v. Text -&gt; v -&gt; HashMap Text v -&gt; HashMap Text v
</span><a href="LaunchDarkly.AesonCompat.html#insertKey"><span class="hs-identifier hs-var">insertKey</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667423"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">Flag
</span><a href="#local-6989586621679667415"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap Flag
</span><a href="#local-6989586621679667416"><span class="hs-identifier hs-var">allFlags</span></a></span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#upsertSegment"><span class="hs-identifier hs-type">upsertSegment</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#ItemDescriptor"><span class="hs-identifier hs-type">ItemDescriptor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Segment"><span class="hs-identifier hs-type">Segment</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span id="upsertSegment"><span class="annot"><span class="annottext">upsertSegment :: Store
-&gt; Text -&gt; ItemDescriptor (Maybe Segment) -&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertSegment"><span class="hs-identifier hs-var hs-var">upsertSegment</span></a></span></span><span> </span><span id="local-6989586621679667414"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667414"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667413"><span class="annot"><span class="annottext">key :: Text
</span><a href="#local-6989586621679667413"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621679667412"><span class="annot"><span class="annottext">versioned :: ItemDescriptor (Maybe Segment)
</span><a href="#local-6989586621679667412"><span class="hs-identifier hs-var">versioned</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store
-&gt; Text
-&gt; Text
-&gt; ItemDescriptor (Maybe Segment)
-&gt; Lens' State (KeyMap (Expirable (CacheableItem Segment)))
-&gt; (Bool -&gt; State -&gt; State)
-&gt; StoreResultM IO ()
forall a.
ToJSON a =&gt;
Store
-&gt; Text
-&gt; Text
-&gt; ItemDescriptor (Maybe a)
-&gt; Lens' State (KeyMap (Expirable (CacheableItem a)))
-&gt; (Bool -&gt; State -&gt; State)
-&gt; StoreResultM IO ()
</span><a href="LaunchDarkly.Server.Store.Internal.html#upsertGeneric"><span class="hs-identifier hs-var">upsertGeneric</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667414"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;segments&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667413"><span class="hs-identifier hs-var">key</span></a></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Segment)
</span><a href="#local-6989586621679667412"><span class="hs-identifier hs-var">versioned</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall s t a b. HasField &quot;segments&quot; s t a b =&gt; Lens s t a b
forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;segments&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; State -&gt; State
forall p p. p -&gt; p -&gt; p
</span><a href="#local-6989586621679667411"><span class="hs-identifier hs-var">postAction</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-413"></span><span>    </span><span id="local-6989586621679667411"><span class="annot"><span class="annottext">postAction :: p -&gt; p -&gt; p
</span><a href="#local-6989586621679667411"><span class="hs-identifier hs-var hs-var">postAction</span></a></span></span><span> </span><span class="hs-identifier">_</span><span> </span><span id="local-6989586621679667410"><span class="annot"><span class="annottext">state :: p
</span><a href="#local-6989586621679667410"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621679667410"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-414"></span><span>
</span><span id="line-415"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#filterAndCacheFlags"><span class="hs-identifier hs-type">filterAndCacheFlags</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TimeSpec</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#SerializedItemDescriptor"><span class="hs-identifier hs-type">SerializedItemDescriptor</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span id="filterAndCacheFlags"><span class="annot"><span class="annottext">filterAndCacheFlags :: Store
-&gt; TimeSpec -&gt; KeyMap SerializedItemDescriptor -&gt; IO (KeyMap Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#filterAndCacheFlags"><span class="hs-identifier hs-var hs-var">filterAndCacheFlags</span></a></span></span><span> </span><span id="local-6989586621679667408"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667408"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span id="local-6989586621679667407"><span class="annot"><span class="annottext">now :: TimeSpec
</span><a href="#local-6989586621679667407"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span id="local-6989586621679667406"><span class="annot"><span class="annottext">serializedMap :: KeyMap SerializedItemDescriptor
</span><a href="#local-6989586621679667406"><span class="hs-identifier hs-var">serializedMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679667405"><span class="annot"><span class="annottext">decoded :: HashMap Text (ItemDescriptor (Maybe Flag))
</span><a href="#local-6989586621679667405"><span class="hs-identifier hs-var hs-var">decoded</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SerializedItemDescriptor -&gt; CacheableItem Flag)
-&gt; KeyMap SerializedItemDescriptor
-&gt; HashMap Text (ItemDescriptor (Maybe Flag))
forall v1 v2.
(v1 -&gt; Maybe v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapMaybeValues"><span class="hs-identifier hs-var">mapMaybeValues</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either Text (ItemDescriptor (Maybe Flag)) -&gt; CacheableItem Flag
forall a b. Either a b -&gt; Maybe b
</span><span class="hs-identifier hs-var">eitherToMaybe</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (ItemDescriptor (Maybe Flag)) -&gt; CacheableItem Flag)
-&gt; (SerializedItemDescriptor
    -&gt; Either Text (ItemDescriptor (Maybe Flag)))
-&gt; SerializedItemDescriptor
-&gt; CacheableItem Flag
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SerializedItemDescriptor
-&gt; Either Text (ItemDescriptor (Maybe Flag))
forall a.
(FromJSON a, HasField' &quot;version&quot; a Natural) =&gt;
SerializedItemDescriptor -&gt; Either Text (ItemDescriptor (Maybe a))
</span><a href="LaunchDarkly.Server.Store.Internal.html#serializedToItemDescriptor"><span class="hs-identifier hs-var">serializedToItemDescriptor</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KeyMap SerializedItemDescriptor
</span><a href="#local-6989586621679667406"><span class="hs-identifier hs-var">serializedMap</span></a></span><span>
</span><span id="line-418"></span><span>        </span><span id="local-6989586621679667404"><span class="annot"><span class="annottext">allFlags :: KeyMap Flag
</span><a href="#local-6989586621679667404"><span class="hs-identifier hs-var hs-var">allFlags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Flag) -&gt; Maybe Flag)
-&gt; HashMap Text (ItemDescriptor (Maybe Flag)) -&gt; KeyMap Flag
forall v1 v2.
(v1 -&gt; Maybe v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapMaybeValues"><span class="hs-identifier hs-var">mapMaybeValues</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a s. HasField' &quot;value&quot; s a =&gt; s -&gt; a
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Text (ItemDescriptor (Maybe Flag))
</span><a href="#local-6989586621679667405"><span class="hs-identifier hs-var">decoded</span></a></span><span>
</span><span id="line-419"></span><span>    </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667408"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, ())) -&gt; IO ())
-&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679667403"><span class="annot"><span class="annottext">state :: State
</span><a href="#local-6989586621679667403"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; (State, ())) -&gt; State -&gt; (State, ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-421"></span><span>            </span><span class="annot"><span class="annottext">Expirable (KeyMap Flag) -&gt; State -&gt; State
forall (f :: Symbol) s a. HasField' f s a =&gt; a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">setField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;allFlags&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyMap Flag -&gt; Bool -&gt; TimeSpec -&gt; Expirable (KeyMap Flag)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap Flag
</span><a href="#local-6989586621679667404"><span class="hs-identifier hs-var">allFlags</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667407"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; State) -&gt; State -&gt; State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-422"></span><span>                </span><span class="annot"><span class="annottext">KeyMap (Expirable (CacheableItem Flag)) -&gt; State -&gt; State
forall (f :: Symbol) s a. HasField' f s a =&gt; a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">setField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;features&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ItemDescriptor (Maybe Flag) -&gt; Expirable (CacheableItem Flag))
-&gt; HashMap Text (ItemDescriptor (Maybe Flag))
-&gt; KeyMap (Expirable (CacheableItem Flag))
forall v1 v2. (v1 -&gt; v2) -&gt; HashMap Text v1 -&gt; HashMap Text v2
</span><a href="LaunchDarkly.AesonCompat.html#mapValues"><span class="hs-identifier hs-var">mapValues</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679667402"><span class="annot"><span class="annottext">x :: ItemDescriptor (Maybe Flag)
</span><a href="#local-6989586621679667402"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CacheableItem Flag
-&gt; Bool -&gt; TimeSpec -&gt; Expirable (CacheableItem Flag)
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Flag) -&gt; CacheableItem Flag
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ItemDescriptor (Maybe Flag)
</span><a href="#local-6989586621679667402"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667407"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Text (ItemDescriptor (Maybe Flag))
</span><a href="#local-6989586621679667405"><span class="hs-identifier hs-var">decoded</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667403"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-423"></span><span>    </span><span class="annot"><span class="annottext">KeyMap Flag -&gt; IO (KeyMap Flag)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">KeyMap Flag
</span><a href="#local-6989586621679667404"><span class="hs-identifier hs-var">allFlags</span></a></span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#getAllFlags"><span class="hs-identifier hs-type">getAllFlags</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="LaunchDarkly.AesonCompat.html#KeyMap"><span class="hs-identifier hs-type">KeyMap</span></a></span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Features.html#Flag"><span class="hs-identifier hs-type">Flag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span id="getAllFlags"><span class="annot"><span class="annottext">getAllFlags :: Store -&gt; StoreResultM IO (KeyMap Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#getAllFlags"><span class="hs-identifier hs-var hs-var">getAllFlags</span></a></span></span><span> </span><span id="local-6989586621679667401"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667401"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>    </span><span id="local-6989586621679667400"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667400"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; IO State
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef State -&gt; IO State) -&gt; IORef State -&gt; IO State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667401"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679667399"><span class="annot"><span class="annottext">memoryFlags :: StoreResultM IO (KeyMap Flag)
</span><a href="#local-6989586621679667399"><span class="hs-identifier hs-var hs-var">memoryFlags</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either Text (KeyMap Flag) -&gt; StoreResultM IO (KeyMap Flag)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (KeyMap Flag) -&gt; StoreResultM IO (KeyMap Flag))
-&gt; Either Text (KeyMap Flag) -&gt; StoreResultM IO (KeyMap Flag)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyMap Flag -&gt; Either Text (KeyMap Flag)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(KeyMap Flag -&gt; Either Text (KeyMap Flag))
-&gt; KeyMap Flag -&gt; Either Text (KeyMap Flag)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a s. HasField' &quot;value&quot; s a =&gt; s -&gt; a
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Expirable (KeyMap Flag) -&gt; KeyMap Flag)
-&gt; Expirable (KeyMap Flag) -&gt; KeyMap Flag
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State -&gt; Expirable (KeyMap Flag)
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;allFlags&quot;</span></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667400"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Store -&gt; Maybe PersistentDataStore
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;backend&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667401"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-430"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StoreResultM IO (KeyMap Flag)
</span><a href="#local-6989586621679667399"><span class="hs-identifier hs-var">memoryFlags</span></a></span><span>
</span><span id="line-431"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667398"><span class="annot"><span class="annottext">backend :: PersistentDataStore
</span><a href="#local-6989586621679667398"><span class="hs-identifier hs-var">backend</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>            </span><span id="local-6989586621679667397"><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667397"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TimeSpec
</span><a href="LaunchDarkly.Server.Store.Internal.html#getMonotonicTime"><span class="hs-identifier hs-var">getMonotonicTime</span></a></span><span>
</span><span id="line-433"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; TimeSpec -&gt; Expirable (KeyMap Flag) -&gt; Bool
forall a. Store -&gt; TimeSpec -&gt; Expirable a -&gt; Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#isExpired"><span class="hs-identifier hs-var">isExpired</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667401"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667397"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">(Expirable (KeyMap Flag) -&gt; Bool)
-&gt; Expirable (KeyMap Flag) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State -&gt; Expirable (KeyMap Flag)
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;allFlags&quot;</span></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667400"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">StoreResultM IO (KeyMap Flag)
</span><a href="#local-6989586621679667399"><span class="hs-identifier hs-var">memoryFlags</span></a></span><span>
</span><span id="line-435"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>                    </span><span id="local-6989586621679667396"><span class="annot"><span class="annottext">Either Text (KeyMap SerializedItemDescriptor)
</span><a href="#local-6989586621679667396"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PersistentDataStore
-&gt; Text -&gt; StoreResult (KeyMap SerializedItemDescriptor)
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreAllFeatures%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreAllFeatures</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentDataStore
</span><a href="#local-6989586621679667398"><span class="hs-identifier hs-var">backend</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-string">&quot;features&quot;</span></span><span>
</span><span id="line-437"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text (KeyMap SerializedItemDescriptor)
</span><a href="#local-6989586621679667396"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-438"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679667395"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679667395"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text (KeyMap Flag) -&gt; StoreResultM IO (KeyMap Flag)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Either Text (KeyMap Flag)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667395"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679667394"><span class="annot"><span class="annottext">serializedMap :: KeyMap SerializedItemDescriptor
</span><a href="#local-6989586621679667394"><span class="hs-identifier hs-var">serializedMap</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>                            </span><span id="local-6989586621679667393"><span class="annot"><span class="annottext">KeyMap Flag
</span><a href="#local-6989586621679667393"><span class="hs-identifier hs-var">filtered</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Store
-&gt; TimeSpec -&gt; KeyMap SerializedItemDescriptor -&gt; IO (KeyMap Flag)
</span><a href="LaunchDarkly.Server.Store.Internal.html#filterAndCacheFlags"><span class="hs-identifier hs-var">filterAndCacheFlags</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667401"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667397"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">KeyMap SerializedItemDescriptor
</span><a href="#local-6989586621679667394"><span class="hs-identifier hs-var">serializedMap</span></a></span><span>
</span><span id="line-441"></span><span>                            </span><span class="annot"><span class="annottext">Either Text (KeyMap Flag) -&gt; StoreResultM IO (KeyMap Flag)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyMap Flag -&gt; Either Text (KeyMap Flag)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">KeyMap Flag
</span><a href="#local-6989586621679667393"><span class="hs-identifier hs-var">filtered</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#isInitialized"><span class="hs-identifier hs-type">isInitialized</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="LaunchDarkly.Server.Store.Internal.html#StoreResult"><span class="hs-identifier hs-type">StoreResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-444"></span><span id="isInitialized"><span class="annot"><span class="annottext">isInitialized :: Store -&gt; StoreResultM IO Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#isInitialized"><span class="hs-identifier hs-var hs-var">isInitialized</span></a></span></span><span> </span><span id="local-6989586621679667392"><span class="annot"><span class="annottext">store :: Store
</span><a href="#local-6989586621679667392"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-445"></span><span>    </span><span id="local-6989586621679667391"><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667391"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef State -&gt; IO State
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef State -&gt; IO State) -&gt; IORef State -&gt; IO State
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667392"><span class="hs-identifier hs-var">store</span></a></span><span>
</span><span id="line-446"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679667390"><span class="annot"><span class="annottext">initialized :: Expirable Bool
</span><a href="#local-6989586621679667390"><span class="hs-identifier hs-var hs-var">initialized</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State -&gt; Expirable Bool
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;initialized&quot;</span></span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667391"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Expirable Bool -&gt; Bool
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="annot"><span class="annottext">Expirable Bool
</span><a href="#local-6989586621679667390"><span class="hs-identifier hs-var">initialized</span></a></span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Either Text Bool -&gt; StoreResultM IO Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text Bool -&gt; StoreResultM IO Bool)
-&gt; Either Text Bool -&gt; StoreResultM IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Either Text Bool
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-449"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Store -&gt; Maybe PersistentDataStore
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;backend&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667392"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-450"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text Bool -&gt; StoreResultM IO Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text Bool -&gt; StoreResultM IO Bool)
-&gt; Either Text Bool -&gt; StoreResultM IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Either Text Bool
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-451"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679667389"><span class="annot"><span class="annottext">backend :: PersistentDataStore
</span><a href="#local-6989586621679667389"><span class="hs-identifier hs-var">backend</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-452"></span><span>                </span><span id="local-6989586621679667388"><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667388"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TimeSpec
</span><a href="LaunchDarkly.Server.Store.Internal.html#getMonotonicTime"><span class="hs-identifier hs-var">getMonotonicTime</span></a></span><span>
</span><span id="line-453"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Store -&gt; TimeSpec -&gt; Expirable Bool -&gt; Bool
forall a. Store -&gt; TimeSpec -&gt; Expirable a -&gt; Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#isExpired"><span class="hs-identifier hs-var">isExpired</span></a></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667392"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667388"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">Expirable Bool
</span><a href="#local-6989586621679667390"><span class="hs-identifier hs-var">initialized</span></a></span><span>
</span><span id="line-454"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-455"></span><span>                        </span><span id="local-6989586621679667387"><span class="annot"><span class="annottext">Either Text Bool
</span><a href="#local-6989586621679667387"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PersistentDataStore -&gt; StoreResultM IO Bool
</span><a href="LaunchDarkly.Server.Store.Internal.html#%24sel%3ApersistentDataStoreIsInitialized%3APersistentDataStore"><span class="hs-identifier hs-var hs-var">persistentDataStoreIsInitialized</span></a></span><span> </span><span class="annot"><span class="annottext">PersistentDataStore
</span><a href="#local-6989586621679667389"><span class="hs-identifier hs-var">backend</span></a></span><span>
</span><span id="line-456"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text Bool
</span><a href="#local-6989586621679667387"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-457"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679667386"><span class="annot"><span class="annottext">err :: Text
</span><a href="#local-6989586621679667386"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text Bool -&gt; StoreResultM IO Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text Bool -&gt; StoreResultM IO Bool)
-&gt; Either Text Bool -&gt; StoreResultM IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text Bool
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679667386"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-458"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679667385"><span class="annot"><span class="annottext">i :: Bool
</span><a href="#local-6989586621679667385"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-459"></span><span>                                </span><span class="annot"><span class="annottext">IORef State -&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Store -&gt; IORef State
forall (f :: Symbol) a s. HasField' f s a =&gt; s -&gt; a
</span><span class="hs-identifier hs-var">getField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;state&quot;</span></span><span> </span><span class="annot"><span class="annottext">Store
</span><a href="#local-6989586621679667392"><span class="hs-identifier hs-var">store</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((State -&gt; (State, ())) -&gt; IO ())
-&gt; (State -&gt; (State, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679667384"><span class="annot"><span class="annottext">stateRef :: State
</span><a href="#local-6989586621679667384"><span class="hs-identifier hs-var">stateRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-460"></span><span>                                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(State -&gt; (State, ())) -&gt; State -&gt; (State, ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-461"></span><span>                                        </span><span class="annot"><span class="annottext">Expirable Bool -&gt; State -&gt; State
forall (f :: Symbol) s a. HasField' f s a =&gt; a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">setField</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;initialized&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; TimeSpec -&gt; Expirable Bool
forall a. a -&gt; Bool -&gt; TimeSpec -&gt; Expirable a
</span><a href="LaunchDarkly.Server.Store.Internal.html#Expirable"><span class="hs-identifier hs-var">Expirable</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679667385"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">TimeSpec
</span><a href="#local-6989586621679667388"><span class="hs-identifier hs-var">now</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State
</span><a href="#local-6989586621679667384"><span class="hs-identifier hs-var">stateRef</span></a></span><span>
</span><span id="line-462"></span><span>                                </span><span class="annot"><span class="annottext">Either Text Bool -&gt; StoreResultM IO Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text Bool -&gt; StoreResultM IO Bool)
-&gt; Either Text Bool -&gt; StoreResultM IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Either Text Bool
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679667385"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-463"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Either Text Bool -&gt; StoreResultM IO Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Text Bool -&gt; StoreResultM IO Bool)
-&gt; Either Text Bool -&gt; StoreResultM IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Either Text Bool
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-464"></span></pre></body></html>